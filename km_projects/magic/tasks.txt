Оглавление

	Общая инфа

	Смена шаблона у Вид/Подвид refs #16647

Общая инфа

	В magic хранится дополнительная информация по товару, которая не должна храниться в 1С (в т.ч. карточки товаров)

Смена шаблона у Вид/Подвид refs #16647

	Сейчас работает так:

		Есть карточка товара (модель ProductCard).

		У карточки товара есть вид-тип (модель Kind). Почему так?

			К примеру, есть ноутбук с видом-типом 'ноутбук-ультрабук'.

		У вида-типа может быть несколько шаблонов (модель ProductCardPreviewTemplate).

		-------------------------------------------------------------------------------- 

		У карточки товара есть шаблон описания (модель ProductCardPreviewTemplate) со связью многие ко многим.

		У шаблона есть вид-тип (модель Kind). Почему так? 

			Возможно, для того, чтобы можно было отображать разные шаблоны для каждого вида-типа.

		------------------------------------------------------------------------------------

		При смене вида-типа у карточки товара, изменение пройдет только для карточек, у которых не изменялся шаблон описания. Изменения для остальных будут отброшены и отправлено письмо.

		При смене шаблона нужно заполнить все пересекающиеся атрибуты, остальные отбросить. (нужна демонстрация)

		Карточку, у которой изменился вид-тип и шаблон, отметить. (нужна демонстрация, как изменить вид-тип и шаблон?)

	Нужно сделать:

		Реализовать механизм, при котором смена шаблона у одного вида\подвида, на другой шаблон, запускала обработку, которая проверяла совпадения по атрибутам в двух шаблонах и перезаполняла их. 

		Если есть расхождения (в чем расхождения?), то такие карточки помечались как требующие заполнения, убирались с сайтов! так же по ним приходило письмо, в котором содержалось их название с кодом товара.

	Возможны несколько вариантов:

		1. Когда в 1С заведен новый вид/подвид в данном случае ничего не надо делать, т.к. у нового вида/подвида, нет никакого шаблона.

		2. Смена шаблона в magic

			пример: http://magic.km-union.ru/cards/property/56/change/?_changelist_filters=q%3D%25D0%25BD%25D0%25BE%25D1%2583%25D1%2582

			Случай, когда я меняю привязку шаблона, к определенному виду/подвиду.

			В данном случае, должно пройти сравнение нового и старого шаблона, проверка всех совпадающих значений атрибутов, а по не совпадающим, приходило бы уведомление, по каким не прошла проверка. (ниже опишу что присылать в письме)

		3.Переименовывание вид/подвид в 1С

			Тут надо ответ от вас, что произойдет в данному случае?
			Появится в magic, новая связка вид/подвид или поменяется уже существующая, с сохранением привязки шаблона и карточек товара!
			Если это второй случай, то должны пройти все те же процедуры, что описаны во втором пункте.
			Для 2 и 3 пункта, если поменялся шаблон, то карточки товаром, которые переподтвердились автоматически, им так же должен быть обновлен слепок на обоих сайтах.
			Письмо уведомление:
			в нем должен быть указан
			- код (ка в 1С) товара, желательно что бы он был кликабельным и вел на карточку товара в magic!
			- Наименование товара
			- название атрибута, по которому не прошла связка шаблонов. Если атрибутов несколько, то их перечисление через запятую.


--------------------------------------------


Модели шаблонов:

    Template - отвечает за сопоставление атрибутов к виду-типу

    TemplateEntry - элемент шаблона, может быть либо атрибутом, если options != None, либо группирующим элементом в противном случае.

    TemplateAttribute - прокси для админки

    ProductCardPreviewTemplate - шаблон для поля описания в карточке товара

    ProductCardNameTemplate - модель "Шаблон наименований" карточки товара

    ProductCardDescriptionTemplate - модель "Шаблон представлений" карточки товара

Свойства (Property) - модель, которая связывает вид-тип и шаблон (многие-ко-многим)

К примеру, есть ноутбук, вид-тип "ноутбук-ноутбук", есть еще типы "ноутбук-ультрабук", "ноутбук-ноутбук без по", "ноутбук-нетбук"; 

можно отображать разные шаблоны для каждого вида-типа;

ProductCard имеет вид-тип, вид-тип имеет разные шаблоны;

Раньше была прямая связь вида-типа и шаблона, но с появлением разных категорий ("ноутбук-нетбук", "ноутбук-ультрабук", ...) стало удобно отображать для них разные шаблоны;

Шаблоны отображаются для набора видов-типов

Сам шаблон состоит из TemplateEntry и он реализует логику (дерево шаблона - производитель и т.д.)

Атрибут (к примеру "производитель") - может быть строковым полем (заполняться руками) или выбором значений из списка к примеру;

Характеристика атрибута (их применимость в рамках шаблона) - другая сущность (поле основное-неосновное, является ли фильтром и т.д.)

Модели атрибутов:

    Attribute - атрибут карточки, связывает хранимое для карточки значение с атомом

    AttributeOptions - атрибут как таковой, он же - атом

    AttributeOptionValue - возможные значения параметров атрибута

Слепок карточки товара (ProductCardDescription) - уже сформированное описание (характеристики) для карточки товара; обновление слепка происходит в тасках update_description_via_change_template_object и update_description_via_change_card; слепки сохраняются, так как их генерация требовала большего времени и создавала дополнительную нагрузку; описания делятся по типам магазина ("korallmicro", "snr_new") Ранее описания и характеристики товара хранились в отдельной базе goods_office, затем ответственность за описания товаров была переложена на проект magic. Для сайта korallmicro описания берутся прямым SQL-запросом к базе magic, для snr - с помощью ORM и моделей подключенного пакета (также из базы magic); Слепки связаны один-к-одному с карточкой товара;


При сохранении/редактировании карточки товара:

    на первой итерации выбирается вид-тип

    по виду-типу система понимает, какой шаблон нужно получить

    анализируются сами атрибуты, понимается, какие виджеты нужно рисовать

    анализируются свойства атрибутов в рамках шаблона - обязательное/необязательное и т.д.

    подгружаются сами значения атрибутов


Для корректного отображения описания карточки:

    получаем шаблон (текст) с атрибутами

    получаем значения атрибутов в рамках этой карточки товара

    заменяем атрибуты в тексте шаблона на полученные значения