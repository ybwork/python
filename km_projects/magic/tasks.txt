Оглавление

	Общая инфа

	Смена шаблона у Вид/Подвид refs #16647

    Проблема с обновлением слепков refs #18150

    Баг: пользователь может привязывать к карточке товара вид-тип у которого нет шаблона, потом когда пользователь заходит и редактирует карточку глючит код внутри метода models/ProductCard/get_filter_values

Общая инфа

	В magic хранится дополнительная информация по товару, которая не должна храниться в 1С (в т.ч. карточки товаров)

Смена шаблона у Вид/Подвид refs #16647

	На 28.02.2019 работает так

		Есть карточка товара, модель ProductCard.

		В карточке товара находится полное описание товара.

		У карточки товара есть вид-тип (ноутбук-ультрабук), модель Kind.

		У вида-типа есть шаблон, модель Template. Для связи шаблона с видом-типом используется модель Property.

		У шаблона есть атрибуты, модель TemplateEntry. Этот набор атрибутов нужен для того, чтобы было понятно, какие атрибуты имеет карточка товара.

		Карточка товара имеет значения атрибутов. Смотреть модели Attribute, AttributeOptions, AttributeOptionValue.

		Значения атрибутов для карточки добавляет пользователь после создания карточки товара, при её редактировании.

		Пользователь может изменить шаблон для вида-типа в 1С и в magic (раздел "Свойства").

		Когда пользователь меняет шаблон у вида-типа в magic (раздел "Свойства"), то весь набор атрибутов у карточки товара тоже меняется. Потому что вид-тип привязан к карточке товара. Соответсвенно это приводит к тому, что все значения атрибутов карточки товара теряются.

	Варианты работы от Глубокова

		1. Когда в 1С заведен новый вид-тип в данном случае ничего не надо делать, т.к. у нового вида-типа, нет никакого шаблона.

		2. Смена шаблона в magic

			пример: http://magic.km-union.ru/cards/property/56/change/?_changelist_filters=q%3D%25D0%25BD%25D0%25BE%25D1%2583%25D1%2582

			Случай, когда я меняю привязку шаблона, к определенному виду-типу.

			В данном случае, должно пройти сравнение нового и старого шаблона, проверка всех совпадающих значений атрибутов, а по не совпадающим, приходило бы уведомление, по каким не прошла проверка.

		3. Переименовывание вид/подвид в 1С

			Тут надо ответ от вас, что произойдет в данному случае?

			Появится в magic, новая связка вид-тип или поменяется уже существующая, с сохранением привязки шаблона и карточек товара!

				Судя по коду появится новая связка вид-тип - (modules/cards/tasks.py/def sync_kinds)

			Если это второй случай, то должны пройти все те же процедуры, что описаны во втором пункте.

			Для 2 и 3 пункта, если поменялся шаблон, то карточки товаром, которые переподтвердились автоматически, им так же должен быть обновлен слепок на обоих сайтах.

	Шаблон и его атрибуты

		TemplateAdmin -> add_to_group_json -> template.groups.create(position=position, parent=group, options=attribute) - привязка атрибута к шаблону, пишется TemplateEntry

	Задача

		При смене шаблона у вида-типа в magic и/или 1С нужно:

			значения совпадающих атрибутов сохранялись 

			карточки товара у которых изменился шаблон помечались, как не актуальные

			администратор получал уведомление о смене шаблонов у карточек товара

				текст письма при смене шаблона, должен содержать: код карточки товара (должны быть кликабельным), имя карточки товара, смена шаблона "с/на" какой (должны быть кликабельными), несовпавщие атрибуты

		Когда шаблон меняется в 1С magic узнает об этом в момент синхронизации. Смотреть задачу check_kind_id_in_cards в modules/cards/tasks.py 

	Отображение атрибутов карточки товара

		Все поля формы берутся через метод get_preview_template_fields модели Kind и добавляются в методе get_form класса ProductCardAdmin.

		    try:
                template = obj.kind.template
            except Template.DoesNotExist:
                return form

            if template:
                form.base_fields.update(template.get_fields(obj))

    Тесты

        Для работы тестов нужно закоментировать в модели Profile поля user и content_type.

    Таски

    	Для запуска таска, который отрабатывает каждый день в 7-мь с чем то и переносит атрибуты карточки товара, выполнять 

    		bin/celery -A app_celery call sync_brands_kinds_in_actual_cards --queue system

Проблема с обновлением слепков refs #18150

    У некоторых карточек товара нет бренда.

    Бренды хранятся в отдельной таблице.

    После того, как карточка товара проверена, создается слепок. Модель ProductCardDescription, сигнал update_description_and_previews_signal, таск update_description_via_change_card.

    Общая схема такая: обновляется карточка товара, отправляется сигнал, обработчик сигнала запускает задачу на создания слепка карточки товара.

    Поле description модели ProductCardDescription - это общие характеристики товара на сайте korallmicro, это поле формата json и в нем есть бренд.

    Создал карточку товара, бренда у нее сначала нет. Через время бренд берется из 1с. Когда бренд подтянулся, зашел в карточку, выбрал "проверена" и нажал сохранить. После этого создался слепок и в нем есть бренд.

    Скорее всего бренд не подтянулся из 1с, а кура нажала "проверена" и сохранила.

    Скрипт обновления слепков карточек у которых в слепке есть None

        codes = ProductCardDescription.objects.filter(description__contains='None')
        update_descriptions_and_previews(
            codes=codes,
            do_update_description=True,
            do_upload_preview=False
        )

    Решение: сделать валидацию, которая не будет позволять делать карточку товара "проверенной" пока у неё не появится бренд.

    	Валидация нужна при сохранении одной карточки и при экшене, который обновляет статус выбранных карточек.

    	Можно написать универсальную валидацию для двух случаев.

    	Валидацию вставляем в class ProductCardAdmin/save_model, mark_cards_as_checked и в формирование слепков карточки товара - task/update_descriptions_and_previews

Товары без фото #18127

	Речь идет о фото карточки товара

	Заходим в карточку товара, нажимаем "Галерея карточки", добавляем фото и сохраняем

	админка ProductCardImageAdmin

    таблица cards_productcardimage

    модель ProductCardImage

	В задача написано: "У нас есть признак date_formed_description, который заполняется текущей датой на последней стадии проверки; если признак проставлен, должна быть полная гарания, что все корректно, включая изображения". На самом деле это не так, потому что карточка товара не связана с продуктом, но при этом date_formed_description заполнен.

	Путь к картинкам находится в слепке карточки товара.

	Слепок карточки товара формируется в таске update_description_via_change_card, при условии, что карточка товара связана с продуктом, то есть у неё есть product_id. При этом выгрузка картинок происходит только в том случае если у карточки товара есть шаблон.

	Судя по комментария в модели ProductCardDescription (слепок), сохранения модели происходит тогда, когда:

		сохранение модели "Карточка товара"
        сохранение модели "картинка "Карточки товара""
        сохранение моделей "ProductCardPreviewTemplate",
        "ProductCardNameTemplate" и "ProductCardDescriptionTemplate"

    -----

    Самое первое создание кт - слепок не формируется

    Обновление кт (без фото и не проверена) - слепок не формируется

    Обновление кт (без фото, но проверена) - слепок не формируется

    Обновление кт (с фото и проверена) - слепок не формируется

    Как правило слепок не формируется, потому что нет связи с продуктом.

    За выгрузку картинок на cdn отвечает таск upload_previews, который вызывается в таске update_descriptions_and_previews

    Вердикт

    	При маркировки списка карточек товара и при сохранении одной отправляется сигнал update_description_and_previews_signal.

    	Этот сигнал слушает separation_task.

    	В separation_task устанавливается параметр do_upload_preview, который сообщает выгружать фотки или нет.

    	Так же в separation_task выполняется таск update_descriptions_and_previews и в него передаются коды карточек.

    	В таске update_descriptions_and_previews в цикле крутятся переданные коды карточек и таск upload_previews, который выгружает фотки для каждой карточки.

    	Таким образом у карточки товара могут быть загруженны фотки и она может быть помечена, как проверенная, при этом у неё может не быть кода товара.

    	Скорее всего он выбирал много карточек и нажимал "Отмитить как проверенные", а у некоторых не было кода 1с.

    Валидация

        У карточки товара должно быть хотя бы одно фото

        Добавление фотографий должно идти без повторов индекса

        Остановился на ProductCardImageFormSet

            в методе clean возможно буду делать валидацию

        При обновлении индексов не меняются имена картинок, а это косяк, потому что картинки будут со старыми именами и некоректно отобразяться в магазинах

        -------------------------

        Карточку можно сделать проверенной, хотя она не готова к проверке. -

Ошибка при синхронизации фильтров #18298

	bin/celery -A app_celery call sync_filter_korallmicro --queue system

	остановился на change_view в ProductCardAdmin

Валидация карточки товара

    Есть момент, когда админ может пометить карточку товара, как проверенную, когда у неё нет ни одной фотки. При этом сейчас это нормально, потому что могут быть товары без фото.

Ошибочные карточки при формировнии кеша ЯМ #18082

    В выгрузку для яндекс маркета должны попадать карточки товара у которых есть фотки.

    class ProductCardModelTest(TestCase):
        """Проверяет работу кастомного функционала (менеджеры, queryset-ы)."""

        def setUp(self):
            """Наполняет бд нужными данными для тестов."""

            kind = Kind.objects.create(
                kind=u'Телефон',
                type=u'Телефон',
                worker=self.user
            )

            template = Template.objects.create()
            TemplateEntry.objects.create(
                template=template,
                name=u'Основные характеристики',
            )
            Property.objects.create(
                kind=kind,
                template=template
            )

            brand = Brand.objects.create(
                uuid='0026ffl3-40c8-11e6-93fc-001b22mad331',
                name='Apple',
                warranty=None
            )

            ProductCard.objects.bulk_create([
                ProductCard(
                    is_ready=True,
                    is_checked=False,
                    is_actual=True,
                    kind=kind
                ),
                ProductCard(
                    code=7,
                    is_ready=True,
                    is_checked=False,
                    is_actual=True,
                    kind=kind
                ),
                ProductCard(
                    code=8,
                    is_ready=True,
                    is_checked=False,
                    is_actual=True,
                    kind=kind,
                    brand=brand,
                ),
                ProductCard(
                    code=9,
                    is_ready=True,
                    is_checked=False,
                    is_actual=True,
                    kind=kind,
                    brand=brand,
                    has_invalid_images=True
                ),
                ProductCard(
                    code=10,
                    is_ready=True,
                    is_checked=True,
                    is_actual=True,
                    kind=kind,
                    brand=brand,
                    has_invalid_images=False
                )
            ])

            ProductCardImage.objects.create(
                card=ProductCard.objects.get(code=10),
                index=0,
                image='test.png'
            )

        def test_get_verified(self):
            """Должен возвращать валидные и проверенные карточки товара."""

            product_card_valid = ProductCard.objects.get_verified()
            self.assertEqual(
                first=product_card_valid.count(),
                second=1
            )

Необходимо получить фото товаров с нашего СДН, по следующим критериям #...

    Дата с 22.04.2019 по 25.04.2019 (выбирать из поля date_checked, потому что это дата, когда карточка была полностью проверена и выгружена на сайт)

    Карточки должны быть готовы к проверки, проверены и иметь картинки.

    product_card_pk_list = ProductCard.objects.filter(
        date_checked__in=['2019-04-22', '2019-04-23', '2019-04-24', '2019-04-25'], 
        images__isnull=False, 
        is_checked=True, 
        is_ready=True, 
        is_actual=True
    ).distinct().values_list('pk', flat=True)

    len(product_card_pk_list)

    images_name_list = ProductCardImage.objects.filter(card__in=product_card_pk_list).values_list('image', flat=True)

    len(images_name_list)

    image_without_path = [image_name.split('/')[1] for image_name in images_name_list]

    cp /media/storage/magic/images/223999_0_20190422_1622.jpg /media/storage/magic/images/224065_0_20190423_1121.jpg ~/TMP

    cp /media/storage/magic/images/223999_0_20190422_1622.jpg /media/storage/magic/images/224065_0_20190423_1121.jpg и т.д.

После подтверждения карточек товара они не появились на боевом #18506

    Причина в формировании кодов для сигнала update_descriptions_and_previews_signal. Если коды формируются до update, то всё ок, если после, то в некоторых случаях update очищает queryset и коды карточки товара формируются некорректно.

    Чудным образом у подтвержденных карточек товаров сбрасывается date_formed_description в None и их нет на сайте.

    date_formed_description выставляется в None, когда выполняется таск update_descriptions_and_previews и метод card_cancel.

    Места где production на сервере не совпадает с production на gitlab

        def mark_as_changed (return)

        def card_cancel (return)
        
        _find_duplicates_action_templates (return False)

        _find_duplicates_for_products (return False)     

Проблема с обработкой изображений с помощью PIL

    Ошибка происходит в том случае, когда original_image.format = none

    Пример

        225115

            original_image.mode = rgba

            original_image.format = none

        220

            original_image.mode = rgb

            original_image.format = jpeg

Пересекающийся товар в неактивных акциях

    Время действие акции "15 лет КМ" не вышло, поэтому и возникала данная проблема.

Integrity Error в синхронизации между magic и 1c.

    Падает таск sync_shop.

    Task sync_shop with id a8304a88-c59d-4254-b5ae-3003666a1cf5 raised exception:
    IntegrityError(1062, "Duplicate entry \'df1771cb-5db6-11e8-80d4-6805ca44419c\' for key \'PRIMARY\'")'

    File "/home/devel/www/magic/modules/catalog/tasks.py", line 620, in sync_shop
    sync(shop_type)
    File "/home/devel/www/magic/modules/catalog/tasks.py", line 444, in sync
    bk_product.flush()

    Группы и катологи это одно и то же.
