Оглавление

	Общая инфа

	Смена шаблона у Вид/Подвид refs #16647

Общая инфа

	В magic хранится дополнительная информация по товару, которая не должна храниться в 1С (в т.ч. карточки товаров)

Смена шаблона у Вид/Подвид refs #16647

	Сейчас работает так:

		Есть карточка товара (модель ProductCard).

		У карточки товара есть вид-тип (модель Kind).

			К примеру, есть ноутбук с видом-типом 'ноутбук-ультрабук'.

		У карточки товара может быть несколько шаблонов описания (модель ProductCardPreviewTemplate, админка ProductCardPreviewTemplateAdmin, таблица mysql-magic-cards_productcard_preview_templates).

		Шаблоны для карточки устанавливаются в фоне (modules/cards/tasks.py/def set_card_preview_template_in_cards)

		------------------------------------------------------------------------------------------------------------------------------

		Есть шаблон описания для карточки товара (модель ProductCardPreviewTemplate, админка ProductCardPreviewTemplateAdmin).

		У шаблона может быть вид-тип.

		У шаблона есть атрибуты (модель )

		------------------------------------------------------------------------------------------------------------------------------

		Есть вид-тип (модель Kind, админка KindAdmin).

		Виды-типы есть в magic и 1c.

		Есть синхронизация видов-типов между magic и 1c (modules/cards/tasks.py/def sync_kinds).

		Для вида-типа можно добавить шаблон.

		-------------------------------------------------------------------------------------------------------------------------------

		При смене вида-типа у карточки товара, изменение пройдет только для карточек, у которых не изменялся шаблон описания. Изменения для остальных будут отброшены и отправлено письмо.

		Смена вида-типа происходит фоном (modules/cards/tasks.py/def check_kind_id_in_cards)

		-------------------------------------------------------------------------------------------------------------------------------

	Нужно сделать:

		Вид/подвид и вид/тип привести к одному типу, потому что это одно и то же.

		"Необходимо реализовать механизм, при котором смена шаблона у одного вида\подвида, на другой шаблон, запускала обработку, которая проверяла совпадения по атрибутам в двух шаблона и перезаполняла их. Если есть расхождения, то такие карточки помечались как требующие заполнения, убирались с сайтов! так же по ним приходило письмо, в котором содержалось их название с кодом товара."

			1. Есть возможность сменить у шаблона вид-тип.

			2. Есть возможность сменить у вида-типа шаблон.

			3. Фоном меняется шаблон у карточки товара.

			4. В разделе "Свойства"

		При каком из описанных выше случаев нужно выполнить задачу?

			При 4-ом, потому что... (см. пункт "Возможны несколько вариантов") 			

		Реализовать механизм, при котором смена шаблона, запускает обработку, которая:

			- берет атрибуты двух шаблонов

				- взять атрибуты текущего шаблона

					Остановился на PropertyAdmin

					возьму из cards_attribute по полю card_id -> card_id возьму из cards_productcardnametemplate

					Переходим в раздел "Свойства" и выбираем одно из них.

					Внутри выбранного св-ва есть вид-тип и шаблон (foreignkey Template).

					Таким образом мы можем получить шаблон через модель Property. Но это не так.

					Модель Template имеет связь с моделью TemplateEntry.

					В модели TemplateEntry есть атрибуты (поле options).

					При выборки из TemplateEntry по полю Template получаем несколько шаблонов.

					Что

						атрибуты конкретного шаблона

					Откуда

						из AttributeOptions

					Как

						join по связанным полям

						условие 

			- сравнивает атрибуты двух шаблонов (старый/новый)

			- собирает все не совпадающие атрибуты

			- помечает карточки товара с этим шаблоном, как требующие заполнения

			- убирает карточки товара с этим шаблоном

			- обновляет слепок на обоих сайтах

			- отправляет отчет с кодом товара и названием, а также название атрибута, по которому не прошла связка шаблонов. (если атрибутов несколько, то их перечисление через запятую)

	Возможны несколько вариантов:

		1. Когда в 1С заведен новый вид/подвид (вид-тип) в данном случае ничего не надо делать, т.к. у нового вида/подвида, нет никакого шаблона.

		2. Смена шаблона в magic

			пример: http://magic.km-union.ru/cards/property/56/change/?_changelist_filters=q%3D%25D0%25BD%25D0%25BE%25D1%2583%25D1%2582

			Случай, когда я меняю привязку шаблона, к определенному виду/подвиду.

			В данном случае, должно пройти сравнение нового и старого шаблона, проверка всех совпадающих значений атрибутов, а по не совпадающим, приходило бы уведомление, по каким не прошла проверка.

		3. Переименовывание вид/подвид в 1С

			Тут надо ответ от вас, что произойдет в данному случае?

			Появится в magic, новая связка вид/подвид или поменяется уже существующая, с сохранением привязки шаблона и карточек товара!

				Судя по коду появится новая связка вид-тип - (modules/cards/tasks.py/def sync_kinds)

			Если это второй случай, то должны пройти все те же процедуры, что описаны во втором пункте.

			Для 2 и 3 пункта, если поменялся шаблон, то карточки товаром, которые переподтвердились автоматически, им так же должен быть обновлен слепок на обоих сайтах.

			Письмо уведомление:

				в нем должен быть указан:

					- код (ка в 1С) товара, желательно что бы он был кликабельным и вел на карточку товара в magic!

					- Наименование товара

					- название атрибута, по которому не прошла связка шаблонов. Если атрибутов несколько, то их перечисление через запятую.
