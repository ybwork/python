Оглавление

	Общая инфа

	Смена шаблона у Вид/Подвид refs #16647

Общая инфа

	В magic хранится дополнительная информация по товару, которая не должна храниться в 1С (в т.ч. карточки товаров)

Смена шаблона у Вид/Подвид refs #16647

	На 28.02.2019 работает так:

		Есть товар.

		У товара есть карточка товара.

		В карточке товара находится полное описание товара.

		У карточки товара есть вид-тип (ноутбук-ультрабук).

		У вида-типа есть шаблон.

		У шаблона есть атрибуты.

		Если вид-тип привязан к карточки товара, то это значит, что и у карточки товара есть шаблон с набором атрибутов.

		Этот набор атрибутов нужен для того, чтобы было понятно, какие атрибуты имеет карточка товара.

		Карточка товара имеет значения атрибутов Они хранятся в таблицах card_attribute, cards_attributeoptions, cards_attributeoptionvalue.

		Атрибуты и их значения для карточки товара создаются пользователем после создания карточки товара. При её редактировании.

		Когда пользователь в разделе "Свойства" меняет шаблон у вида-типа, весь набор атрибутов у карточки товара тоже меняется. Потому что вид-тип привязан к карточке товара.

	Задача

		Меняется шаблон у вида-типа.

		Если атрибуты старого шаблона совпадают с атрибутами нового, то значения атрибутов старого должны появится в значения нового.

		Те атрибуты старого шаблона, которые не совпадают исчезают.

		У карточки есть атрибуты

			cards_attribute

					options_id

					card_id

					value_text

		Меняется шаблон

			Если имя старого атрибута равно новому, то добавляем значение старого в новый.

			Удаляются все значения атрибутов из cards_attribute.

			Создаются новые значения атрибутов в cards_attribute.

			-----

			Если нет совпадения по атрибутам, то удаляем из cards_attribute все атрибуты старого шаблона.

			Если в таблице cards_attribute не будет значений атрибутов, то админу нужно будет заполнить их.

			Если старый атрибут есть в новом шаблоне, то ничего не делаем.

	Отображение полей описания карточки товара

		Все поля формы берутся через метод get_preview_template_fields модели Kind и добавляются в методе get_form класса ProductCardAdmin.

		    try:
                template = obj.kind.template
            except Template.DoesNotExist:
                return form

            if template:
                form.base_fields.update(template.get_fields(obj))

	Тест

		Смартфон-Смартфон

		Смартфон Huawei Y6 Prime 2018 Dual Sim 5.7" 1440x720/16Gb/3G/LTE/WiFi/BT/GPS/Cam 13Mpix+8Mpix/3000 mAh/And 8.0 синий

		Не меняется шаблон типа-вида в разделе Свойства.

	Сейчас работает так:

		Есть карточка товара (модель ProductCard).

		У карточки товара есть вид-тип (модель Kind).

			К примеру, есть ноутбук с видом-типом 'ноутбук-ультрабук'.

		У карточки товара может быть несколько шаблонов описания (модель ProductCardPreviewTemplate, админка ProductCardPreviewTemplateAdmin, таблица mysql-magic-cards_productcard_preview_templates).

		Шаблоны для карточки устанавливаются в фоне (modules/cards/tasks.py/def set_card_preview_template_in_cards)

		------------------------------------------------------------------------------------------------------------------------------

		Есть шаблон описания для карточки товара (модель ProductCardPreviewTemplate, админка ProductCardPreviewTemplateAdmin).

		У шаблона может быть вид-тип.

		У шаблона есть атрибуты (модель )

		------------------------------------------------------------------------------------------------------------------------------

		Есть вид-тип (модель Kind, админка KindAdmin).

		Виды-типы есть в magic и 1c.

		Есть синхронизация видов-типов между magic и 1c (modules/cards/tasks.py/def sync_kinds).

		Для вида-типа можно добавить шаблон.

		-------------------------------------------------------------------------------------------------------------------------------

		При смене вида-типа у карточки товара, изменение пройдет только для карточек, у которых не изменялся шаблон описания. Изменения для остальных будут отброшены и отправлено письмо.

		Смена вида-типа происходит фоном (modules/cards/tasks.py/def check_kind_id_in_cards)

		-------------------------------------------------------------------------------------------------------------------------------

		Есть атрибуты

		    AttributeOptions - атрибут

		    AttributeOptionValue - возможные значения параметров атрибута
		    
		    Attribute - атрибут карточки, связывает хранимое для карточки значение

	Нужно сделать:

		Вид/подвид и вид/тип привести к одному типу, потому что это одно и то же.

		"Необходимо реализовать механизм, при котором смена шаблона у одного вида\подвида, на другой шаблон, запускала обработку, которая проверяла совпадения по атрибутам в двух шаблона и перезаполняла их. Если есть расхождения, то такие карточки помечались как требующие заполнения, убирались с сайтов! так же по ним приходило письмо, в котором содержалось их название с кодом товара."

			1. Есть возможность сменить у шаблона вид-тип.

			2. Есть возможность сменить у вида-типа шаблон.

			3. Фоном меняется шаблон у карточки товара.

			4. В разделе "Свойства"

		При каком из описанных выше случаев нужно выполнить задачу?

			При 4-ом, потому что... (см. пункт "Возможны несколько вариантов") 			

		Реализовать механизм, при котором смена шаблона, запускает обработку, которая:

			ProductCardAdmin - 

			ProductCardImageAdmin -

			RejectedProductCardAdmin - 

			ProductCardPreviewTemplateAdmin - 

			ProxyProductCardPreviewTemplateAdmin - 

			ProductCardNameTemplateAdmin - 

			ProductCardDescriptionTemplateAdmin - 

			check_kind_id_in_cards - синхронизация с 1с

			Остановился на ProductCardAdmin, метод save_model

			Новое значение, которое возможно нужно будет менять - ProductCardDescription -> characteristics =

			Есть модель TemplateEntry.

			Если в модели TemplateEntry есть значение у поля options, то это атрибут.

			У модели TemplateEntry есть поле name. Его можно считать значением атрибута, если запись из TemplateEntry является атрибутом? 

			Есть модель AttributeOptionValue.

			В модели AttributeOptionValue, в поле value хранится значение атрибута.

			Если запись из модели TemplateEntry является атрибутом, то что является значением атрибута, значение из поля name модели TemplateEntry или значение из поля value модели AttributeOptionValue?

			- берем старый шаблон (объект)

			- берем новый шаблон (объект)

			- сравниваем 2 шаблона

				- берем имена атрибутов и значения нового шаблона

					obj.template.groups.all()[1].options.name - имя шаблона

					obj.template.groups.all()[1].options.available_values.all() - значения шаблона

				- если имя атрибута новго шаблона нет в старом, то создаем в базе

					таблица attr_template_list для имен

					таблица cards_attributeoptionvalue для значений

					получить список всех карточек товара у которых вид-тип = obj.kind.pk с шаблоном-pk = obj.pk

			- помечаем и убираем карточки товара с этим шаблоном, как требующие заполнения +

				ProductCard

					is_ready = True

					is_checked = False

					is_actual = False

			- отправляет отчет с сылкой на карточку товара

	Возможны несколько вариантов:

		1. Когда в 1С заведен новый вид/подвид (вид-тип) в данном случае ничего не надо делать, т.к. у нового вида/подвида, нет никакого шаблона.

		2. Смена шаблона в magic

			пример: http://magic.km-union.ru/cards/property/56/change/?_changelist_filters=q%3D%25D0%25BD%25D0%25BE%25D1%2583%25D1%2582

			Случай, когда я меняю привязку шаблона, к определенному виду/подвиду.

			В данном случае, должно пройти сравнение нового и старого шаблона, проверка всех совпадающих значений атрибутов, а по не совпадающим, приходило бы уведомление, по каким не прошла проверка.

		3. Переименовывание вид/подвид в 1С

			Тут надо ответ от вас, что произойдет в данному случае?

			Появится в magic, новая связка вид/подвид или поменяется уже существующая, с сохранением привязки шаблона и карточек товара!

				Судя по коду появится новая связка вид-тип - (modules/cards/tasks.py/def sync_kinds)

			Если это второй случай, то должны пройти все те же процедуры, что описаны во втором пункте.

			Для 2 и 3 пункта, если поменялся шаблон, то карточки товаром, которые переподтвердились автоматически, им так же должен быть обновлен слепок на обоих сайтах.

			Письмо уведомление:

				в нем должен быть указан:

					- код (ка в 1С) товара, желательно что бы он был кликабельным и вел на карточку товара в magic!

					- Наименование товара

					- название атрибута, по которому не прошла связка шаблонов. Если атрибутов несколько, то их перечисление через запятую.

-----------------

Карточки товара, шаблоны, описание и их связь
В magic хранится дополнительная информация по товару, которая не должна храниться в 1С (в т.ч. карточки товаров)
Карточка товара (ProductCard)
    kind - вид-тип товара
    preview_template - шаблон (то, что будет выгружено на сайт в качестве описания; описаний может быть несколько для каждого вида-типа)
Если соответствующий шаблон один, то он выбирается автоматически; если нет, то пользователь может выбрать любой из соответствующих этому виду-типу;
Шаблон (Template) - набор атрибутов и их свойств;
У карточки товара есть шаблон поля описания (ProductCardPreviewTemplate) для какого-то типа магазина (snr/korallmicro/...), связанный через модель kind (многие-ко-многим, отдельная таблица)
Модели шаблонов:
    Template - отвечает за сопоставление атрибутов к виду-типу
    TemplateEntry - элемент шаблона, может быть либо атрибутом, если options != None, либо группирующим элементом в противном случае.
    TemplateAttribute - прокси для админки
    ProductCardPreviewTemplate - шаблон для поля описания в карточке товара
    ProductCardNameTemplate - модель "Шаблон наименований" карточки товара
    ProductCardDescriptionTemplate - модель "Шаблон представлений" карточки товара
Свойства (Property) - модель, которая связывает вид-тип и шаблон (многие-ко-многим)
К примеру, есть ноутбук, вид-тип "ноутбук-ноутбук", есть еще типы "ноутбук-ультрабук", "ноутбук-ноутбук без по", "ноутбук-нетбук"; можно отображать разные шаблоны для каждого вида-типа;
ProductCard имеет вид-тип, вид-тип имеет разные шаблоны;
Раньше была прямая связь вида-типа и шаблона, но с появлением разных категорий ("ноутбук-нетбук", "ноутбук-ультрабук", ...) стало удобно отображать для них разные шаблоны;
Шаблоны отображаются для набора видов-типов
Сам шаблон состоит из TemplateEntry и он реализует логику (дерево шаблона - производитель и т.д.)
Атрибут (к примеру "производитель") - может быть строковым полем (заполняться руками) или выбором значений из списка к примеру;
Характеристика атрибута (их применимость в рамках шаблона) - другая сущность (поле основное-неосновное, является ли фильтром и т.д.)
Модели атрибутов:
    Attribute - атрибут карточки, связывает хранимое для карточки значение с атомом
    AttributeOptions - атрибут как таковой, он же - атом
    AttributeOptionValue - возможные значения параметров атрибута
Слепок карточки товара (ProductCardDescription) - уже сформированное описание (характеристики) для карточки товара; обновление слепка происходит в тасках update_description_via_change_template_object и update_description_via_change_card; слепки сохраняются, так как их генерация требовала большего времени и создавала дополнительную нагрузку; описания делятся по типам магазина ("korallmicro", "snr_new") Ранее описания и характеристики товара хранились в отдельной базе goods_office, затем ответственность за описания товаров была переложена на проект magic. Для сайта korallmicro описания берутся прямым SQL-запросом к базе magic, для snr - с помощью ORM и моделей подключенного пакета (также из базы magic); Слепки связаны один-к-одному с карточкой товара;
При сохранении/редактировании карточки товара:
    на первой итерации выбирается вид-тип
    по виду-типу система понимает, какой шаблон нужно получить
    анализируются сами атрибуты, понимается, какие виджеты нужно рисовать
    анализируются свойства атрибутов в рамках шаблона - обязательное/необязательное и т.д.
    подгружаются сами значения атрибутов
Для корректного отображения описания карточки:
    получаем шаблон (текст) с атрибутами
    получаем значения атрибутов в рамках этой карточки товара
    заменяем атрибуты в тексте шаблона на полученные значения

-----------------------------------------------------------------

дополнение после собрания 26.02.2019


1. Изменение вид-типа будет происходить только в 1С

2. Возможно изменение привязанного шаблона в magic. при этом так же должны запускаться процессы перепривязки карточек, к новому шаблону.

3. при смене шаблона, должны сбрасываться шаблоны описания и наименование, привязанные к связки вид/подвид



текст письма при смене шаблона, должен содержать:

- код товара (он должен быть кликабельным и вести в карточку товара)

- наименование товара

- смена шаблона "с/на" какой

- факт сброса шаблонов описания товара и наименования, желательно указать названия этих шаблонов и сделать их кликабельными для перехода на их.


ни каких интерфейсных доработок оп magic делать не надо.

attr_old_list = self.compare_templates(
    # делаю так, потому что нет доступа к старому шаблону
    template_old=Property.objects.get(pk=obj.pk).template,
    template_new=obj.template
)

product_card_list = obj.kind.cards.all()

Attribute.objects.filter(
    options__in=attr_old_list
).filter(
    card__pk__in=product_card_list.values_list('pk')
).delete()

self.create_report_about_attr_sync(
    product_card_list=product_card_list
)

self.mark_product_cards_how_are_not_actual(
    cards=product_card_list
)

obj.save()