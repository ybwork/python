Оглавление

	Развертывание

	Карточка товара

	Слепок карточки товара

	Картинки карточки товара

	Статьи

	Группы рассылки

Развертывание

	Перед развертыванием убедиться, что в системе установлены:

	    postgresql 9.5

	    mysql 5.7

	    rabbitmq

	    rabbitmq management

	    python-mysqldb

	Получение проекта

	    Если настроен ssh, то git clone git@gitlab0.km-union.ru:python/magic.git

	    Если не настроен ssh, то git clone http://gitlab0.km-union.ru/python/magic.git

	Окружение и зависимости

	    Автоматическое создание

	        Переходим в корень проекта и в terminal:

	            chmod +x deploy_local.sh

	            ./deploy_local.sh

	    Ручное создание

	        Переходим в корень проекта и в terminal:

	            python create_bootstrap.py → в корне проекта должен создасться bootstrap.py

	            python bootstrap.py → рядом с директорией проекта должна создасться директория с виртуальным окружением magic-env и в корневой директории проекта
	            должна создасться директория bin

	            bin/pip install -r requirements.txt → убедиться, что все пакеты установились без ошибок

	            Переходим в директорию conf, открываем файл settings_local.py.template, копируем все

	            В директории conf создаем файл settings_local.py и вставляем все скопированное из settings_local.py.template
	        
	        Создаем в корне проекта директорию change_log и в ней директории korallmicro и snr.

	            change_log

	                korallmicro

	                snr

	Settings local

	    Для корректной работы информирования установить EMAIL_DEFAULT_FROM='magic_local@error.com'

	Устанавливаем нужные версии субд в docker контейнерах

	    Должен быть установлен docker server

	    PostgreSQL

	        Создаем директории для точек монтирования на локальной машине от имени суперпользователя:

	            sudo mkdir ~/your_path/volumes/postgres_9.5/config

	            sudo mkdir ~/your_path/volumes/postgres_9.5/data

	        Создаем docker контейнер:

	            sudo docker run \            
	            --name postgres_9.5 \
	            -v ~/your_path/volumes/postgres_9.5/config:/etc/postgresql \
	            -v ~/your_path/volumes/postgres_9.5/data:/var/lib/postgresql/data \
	            -p 5432:5432 \
	            -e POSTGRES_PASSWORD=asdf1234 \
	            -d postgres:9.5

	   MySQL

	        Создаем директории для точек монтирования на локальной машине от имени суперпользователя:

	            sudo mkdir ~/your_path/volumes/postgres_9.5/config

	            sudo mkdir ~/your_path/volumes/postgres_9.5/data

	        Создаем docker контейнер:

	            sudo docker run \            
	            --name mysql_5.7 \
	            -v ~/your_path/volumes/mysql_5.7/config:/etc/mysql/conf.d \
	            -v ~/your_path/volumes/mysql_5.7/data:/var/lib/mysql \
	            -p 3306:3306 \
	            -e MYSQL_ROOT_PASSWORD=asdf1234 \
	            -d mysql:5.7

	Создаём нужные базы данных

	Выполняем миграции

	    В корневой директории проекта из консоли выполняем: bin/manage migrate

	Заливаем дампы в базы

	    Список нужных дампов: magic, online_shop_info, goods_office, korallmicro, snr.

	    Дампы можно взять так:

	        sudo mount -t nfs 10.10.100.211:/nfs-backups /mnt/backups/

	        mc

	        alt + c

	        /mnt

	        заходим в backups

	        ищем последнюю дату и заходим в эту директорию

	        находим нужный бэкап в формате bz2 и в названии должно быть sql

	        f5

	RabbitMQ

	    Удостовериться, что settings_local.py имеет:

	        BROKER_URL = [
	            "amqp://guest:guest@localhost:5672/magic"
	        ]

	        BROKER_TARGET_URL = [
	            "amqp://guest:guest@localhost:5672/broker"
	        ]

	        guest:guest - это логин и пароль от rabbit

	        /magic и /broker - это имена виртуальных хостов rabbit-а, которые должны быть созданы.

	   Виртуальные хосты можно создать через web морду:

	       идем в Admin -> Virtual Hosts -> Add virtual host

	Celery

	    Для запуска пишем в консоль: bin/celery -A app_celery worker -l info -Q default,system,description,image_prepare --purge


Карточка товара

	Есть интернет магазины korallmicro и snr.

	Карточка товара - это описание и набор фотографий для каждого продукта, который представлен в этих магазинах.

	Карточка товара создаётся и наполняется менеджерами интернет магазинов.

	Более детальная информация:

		Описан в модели ProductCard.

		Сохраняется в базу magic, таблица cards_productcard.

		На локальной машине этот процесс можно посмотреть по адресу http://localhost:8000/cards/productcard/

Слепок карточки товара

	Есть карточка товара.

	У карточки товара есть слепок.

	Слепок это запись в другой таблице.

	Слепок карточки товара формируется после того, как карточка помечена, как "проверена".

	Интернет магазины korallmicro и snr берут данные для карточки товара напрямую из слепков.

	Более детальная информация:

		Описан в модели ProductCardDescription.

		Сохраняется в базу magic, таблица cards_productcarddescription.

		Формирование происходит в фоне с помощью celery и таскa update_description_via_change_card.

Картинки карточки товара

	У карточки товара может не быть картинок при условии, что стоит галочка в поле "Не валидные изображения".

	Если не стоит галочка в поле "Не валидные изображения", то у карточки товара должно быть минимум одна, главная картинка.

	Главная картинка - это картинка с индексом 0.

	При добавлении картинок им задаются индексы.

	Обязательно одна из картинок должна иметь индекс 0 и индексы не должны дублироваться.

	С помощью индексов можно задать порядок картинок.

	В заданном порядке эти картинки будут отображаться на у каждого продукта на сайтах korallmicro и snr.

Подтверждение карточек товара

	Карточки товара создает и заполняет специально обученный человек.

	Такой же специально обученный человек проверяет их и решает валидная карточка товара или нет.

	Если валидная, то карточка товара помечается, как подтвержденная.

	Можно подтверждать пачками, а можно по одной.

	После подтверждения в фоне происходит ряд действий (выгружаются картинки на CDN, создаётся слепок).

	Если в фоне все задачи завершились успешно, то у карточки/карточек обновляется параметр date_formed_description (в это поле попадает текущая дата и время).

	Только после обновления параметра date_formed_description карточка товара считается полностью подтвержденной.

Статьи

	Статьи отображаются на сайтах korallmicro и snr.

	Для написания статьи пользователи magic используют tinymce.

	Иногда возникает потребность изменить какие-либо св-ва редактора, например ширину окна.

	Это можно сделать использовав настройки tinymce в файле settings.py (см. TINYMCE_DEFAULT_CONFIG)

Шаблоны

	У каждой карточки товара есть вид-тип.

	К каждому виду-типу можно привязать шаблон.

	К каждому шаблону можно добавить атрибуты.

	Пример:

		Есть вид-тип "Сетевой фильтр-UPS".

		У этого вида-типа есть шаблон "Шаблоны для EURO-Сетевой фильтр, UPS-Сетевой фильтр, удлинитель-Сетевой фильтр".

		У этого шаблона есть атрибуты "Модель, Максимальный входной ток А, Фильтрация помех, Защита от КЗ, Предохранители" и т.д.

	На основе атрибутов шаблона magic формирует поля для заполнения в тех карточках товара к которым привязан вид-тип.

Группы рассылки

    При определенных условиях пользователям и разработчикам системы приходят уведомления. Для разных уведомлений существуют определенные группы рассылки.

    Здесь будет описано какие существуют группы рассылки, кто в них находится и в каких случаях туда приходят письма.

    ADMINS

        В эту группу входят ответственные за поддержку системы.

        Сюда приходят сообщения после логгирования (уровень ERROR) и при возникновении других ошибок.

        Смотреть вызовы logger.error, mail_admins, send_html_email в методе to_dict модели InfoCatalog.

        На 30.04.2019 в этой группе:

            alexandr_angilenko@km-union.ru

            senchenko_vs@km-union.ru

            kaduk_ia@km-union.ru

    MANAGERS

        В эту группу входят управляющие этой системы.

        Смотреть вызов метода mail_managers.

        На 30.04.2019 в этой группе:

            alexander_glubokov@km-union.ru

            vlad_vaholsky@km-union.ru

    KMCLIENT_NOTIFICATION_EMAILS

        Судя по коду нигде не используется.

    SYSTEM_NOTIFICATION_EMAIL_GROUPS

        В эту группу входят ответственные за поддержку системы.

        Сюда приходят сообщения о различных процессах работы системы, которые происходят в фоне. Например "формирование фильтров на сайт" или "появились карточки товара с новыми шаблонами" и т.п.

        Для более подробной инфы смотреть таски в приложениях card, catalog, istore, korallmicro, ones.

        На 30.04.2019 в этой группе:

            alexandr_angilenko@km-union.ru

            senchenko_vs@km-union.ru

            kaduk_ia@km-union.ru

    FRIENDS_FROM_1C_EMAIL_GROUPS

        Судя по коду нигде не используется.

    FRIENDS_FROM_INTEGRATOR_EMAIL_GROUPS

        Судя по коду нигде не используется.

    CONTENT_MANAGER_NOTIFICATION_EMAIL_GROUPS

        В эту группу входят контент менеджеры различных магазинов.

        Сюда приходят сообщения о различных процессах работы системы, которые происходят в фоне. Например "формирование фильтров на сайт" или "появились карточки товара с новыми шаблонами" и т.п.

        Для более подробной инфы смотреть таски в приложениях card, catalog, istore, korallmicro, ones.

        На 30.04.2019 в этой группе:

            korallmicro - alexander_glubokov@km-union.ru, vlad_vaholsky@km-union.ru

            istore - alexander_glubokov@km-union.ru, Azevich_EM@km-union.ru

            snr_new - alexander_glubokov@km-union.ru, vlad_vaholsky@km-union.ru

    REVIEW_CHECKER_NOTIFICATION_EMAIL_GROUPS

        В эту группу входят проверяющие отзывы на товары.

        Сюда приходят письма, когда пользователь оставил отзыв о товара.

        На 30.04.2019 в этой группе:

            aleksey_lomakin@km-union.ru

    OFFERS_CHECKER_NOTIFICATION_EMAIL_GROUPS

        В эту группу входят ответственные за выгодные предложения.

        Сюда приходят письма об существующих выгодных предложениях и сроке их действия.

        На 30.04.2019 в этой группе:

            folvarkov@mail.ru

            alexandrcms@gmail.com

            skvooz@gmail.com

    UNIQUE_FULL_ALIAS_CHECKER_NOTIFICATION_EMAIL_GROUPS

        В эту группу входят ответственные за каталогом.

        Сюда приходят письма, когда происходит ошибка при синхронизации с 1С для сайта.

        На 30.04.2019 в этой группе:

            alexandrcms@gmail.com

            aleksey_lomakin@km-union.ru

            alexander_glubokov@km-union.ru

    ACTUAL_CHECKER_NOTIFICATION_EMAIL_GROUPS

        В эту группу входят ответственные за смену актуальности карточки товара.

        Сюда приходят письма, когда изменился параметр is_actual у карточки товара.

        Это происходит в фоне, поэтому смотреть в тасках приложения cards.

        На 30.04.2019 в этой группе:

            svetlana_koroleva@km-union.ru

            tatyana_zakharova@km-union.ru

    CONFIGURATOR_ANALITICS

        В эту группу входят ответственные за проверку статистики по конфигуратору.

        На 30.04.2019 скорее всего его выпилили.

        На 30.04.2019 в этой группе:

            fastunova_va@km-union.ru

    SITE_PRODUCTS_REPORT_EMAILS

        В эту группу входят ответственные за проверку отчетов о карточках товаров.

        Сюда приходят письма, при формировании отчетов о карточках товаров.

        Отчеты формируются в фоне. Смотреть таски приложения cards.

        На 30.04.2019 в этой группе:

            alexander_glubokov@km-union.ru

            abakarov_ag@km-union.ru

            angilenko_aa@km-union.ru

            senchenko_vs@km-union.ru

            kaduk_ia@km-union.ru

    CRITICAL_ERROR_EMAIL_GROUPS

        В эту группу входят ответственные за управление и поддержку системы.

        Сюда приходят письма, когда возникают критические для работы системы ошибки.

        Судя по коду это: "Ошибка обновления данных на стороне magic после анализа существующих объектов."

        На 30.04.2019 в этой группе:

            vlad_vaholsky@km-union.ru

            alexander_glubokov@km-union.ru

            aleksey_lomakin@km-union.ru

            malashikhin_da@km-union.ru

            mihail_shinkarenko@km-union.ru

            alexandr_angilenko@km-union.ru

            senchenko_vs@km-union.ru

            kaduk_ia@km-union.ru


	