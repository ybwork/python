Невозможно отменить заказы #18943

	У дилера из Ленинградской есть два заказа которые он не может отменить.

	dp пишет ошибку, что нельзя завершить уже завершенный заказ.

		По логике все верно.

	В админке в заказах статус "Завершено", а отображается в "необходимо связаться с покупателем".

	Смотреть на признак need_to_call.

	Вопросы:

		Где должны отображаться заказы со статусом "Отменен"?

			В разделе "Все заказы".

	orders_order - id - 157172

	Причина возникновения бага:

		Завершенный заказ не может быть завершен, пока диллер не нажал кнопку "Созвонились".

		Дмитрий Малашыхин говорит, что это ненормальное поведение и что возможно они когда то давно при тестировании допустили косяк.

		Сейчас этот косяк нужно исправить и давать возможность диллеру отменять заказ даже если он не созвонился с заказчиком.

	orders/urls/__init__.py

		wrapper_need_to_call_orders_view

	orders/views/arm.py

		NeedToCallOrdersView

Защита от DDOS атаки яндекса #17614

	Когда робот яндекса сходит с ума, он начинает запрашивать фид по несколько раз в секунду... это ложит наш ресурс...

	Необходимо лимитировать запросы...

	Вопросы:

		Что такое фид?

			Фид - это файл, содержащий в себе информацию о товаре или услуге. 

			Может быть нескольких форматов: YML, XML, CSV,  GZ, TSV, ZIP.

		Где в snr урл, который отдает файл с фидом?

			modules/main/__init__.py

			    url(r'^yandex_market/{}/(?P<subdomain>\w+).yml$'

		Как получить руками файл с фидом?

			Перейти по адресу http://127.0.1.1:8100/yandex_market/8319d51f-98d2-4b2a-992d-a2ab5461effa/anapa.yml

		Где место, которое формирует фид?

			main/views/market.py

				YandexMarketView

					engine/views/main/market.py

						YandexMarketView -> BaseYml -> TemplateView

	Что

		Лимитировать запросы яндекса.

		Если больше какого то кол-ва в минуту, то блокируем.

		Потом отправляем письмо диллерам и админам.

		Если атака остановилась, то опять отправляем диллерам и админам письмо, а яндексу разрешаем обращаться.

	Как

		Сохранять текущую минуту и кол-во запросов.

			Сохраняем в кеш.

			Сбрасываем кэш.

		Перед каждым запросом берем по ключу минуту (дата и время) и кол-во запросов, которое уже сделано.

		Если больше заданного лимита, то отбиваем запросы и отправляем письмо яндекс-роботу и группе заинтересованных.

	Как

		Получаем запрос

		Нужно чистить кэш на каждой новой минуте или делать по другому.

			Пишем кэш в формате 

				ключ = {
					время = кол-во обращений
				}

			Если при проверке не находит время, то отчищаем весь кэш по ключу.

		Смотрим есть ли кэш

			Если нет кэша по данной временной метке, то создаем

			Если есть кэш, то проверяем кол-во запросов

				Если лимит привышем, то выходим

				Если нет, то даем запросу пройти дальше

		cache.set

			key => {

				time => count
			}

		cache.get

		if

		cache

			cache.delete_pattern('key')


		---

		current_date_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

		limit_get_feed_in_minute = 4

		request_count = cache.get_or_set('request_count', 'request_count', {})

		if current_date_time not in request_count:
			cache.delete('request_count')
			cache.set('request_count', {current_date_time: 1})

		if  request_count[current_date_time] > limit_get_feed_in_minute:
			return None

		cache.set('request_count', {current_date_time: limit_get_feed_in_minute += 1})







