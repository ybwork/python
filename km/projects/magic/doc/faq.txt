Оглавление

	Галочка "Не для интернет магазина"

	Кол-во распределенного товара вне диапозона

	Бесконечный цикл при создании каталогов

	Проблема с выгодными предложениями

	Проблема с количеством товара на сайте

Галочка "Не для интернет магазина"

	В 1с товару поставили галочку "Не для интернет магазина", но он всеравно отображается на сайте

		Причина: потому что товар отвязан от категории в 1c. Смотреть в разделе "Иерархия групп объектов обмена".

		На 4.09.19 если в 1с стоит галочка "Не для интернет магазина", то это значит, что продукт не должен быть на сайтах korallmicro и istore.

		Если говорить в терминах 1с, то номеклатура не имеет связи с каталогом.

		Для того, чтобы исправить ситуацию нужно:

			привязать номенклатуру к каталогу в 1с

			найти в бд magic лишние связи товара с категорией для сайтов korallmicro и istore:

				SELECT
				    c_c.id,
				    c_c.type
				FROM
				    magic.catalog_distributions c_d
				        LEFT JOIN
				    magic.catalog_catalog c_c ON c_d.catalog_id = c_c.id
				WHERE
				    product_id = 1987
				        AND c_c.type IN ('korallmicro' , 'istore');

			удаляем из бд magic лишние связи товара с категорией для сайтов korallmicro и istore:

				DELETE FROM
				    magic.catalog_distributions
				WHERE
				    product_id = 1987
				        AND catalog_id IN (281904, 319023)

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

		Если не помогло, то:

			просим ответственного за проект убрать у продукта в 1с галочку "Не для интернет магазина"

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

			просим ответственного за проект вернуть продукту в 1с галочку "Не для интернет магазина"

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

Кол-во распределенного товара вне диапозона

	Ошибка при синхронизации с 1с "Кол-во распределенного товара вне диапозона".

		Причина: потому что кол-во продуктов в 1с сильно отличается от кол-ва продуктов в magic.

		Если ответственный за проект много работал в 1с с продуктами, то это нормальная ситуация.

		Для решения проблемы нужно связаться с ответственным за проект и узнать работал ли он с продуктами и каталогами в 1с. 

			Если работал, то просим у ответсвенного за проект разрешения на "синхронизацию без доверительного интервала".

			Если разрешает, то:

				находим на рабочей почте письмо об ошибке и смотрим для какого магазина она произошла (snr, korallmicro, istore)

					Task was called with args: [] kwargs: {u'shop_type': u'korallmicro'}

					Это говорит, что ошибка произошла при синхронизации для korallmicro

				в 1-ой консоле заходим на боевой magic

					ssh devel@192.168.7.76

					открываем файл с логами, выполняющихся фоновых задач

						tail -f ~/log/magic-celery-system.txt

				во 2-ой консоле заходим на боевой magic

					ssh devel@192.168.7.76

					переходим в корень проекта

						cd ~/www/magic

					смотрим в открытый файл с логами выполняющихся фоновых задач и убеждаемся, что нет запущенных sync_shop

					выполняем синхронизацию для нужного магазина вручную и без сравнения кол-ва товаров

						bin/celery call -A app_celery sync_shop --queue=system --args='["название нужного магазина, например istore", false]'

		Если ответсвенного за проект не разрешает выполнить "синхронизацию без доверительного интервала", то исследуем код и ищем проблему.

			открываем /magic/modules/catalog/tasks.py

			ищем там if use_confidence_interval

			разбираемся

Бесконечный цикл при создании каталогов

	Ошибка при синхронизации с 1с "Бесконечный цикл при создании каталогов".

		Причина: потому что в 1с помеченный "на удаление" каталог, не удаляется из базы 1c_8_raw.

		Смотреть разницу между интерфейсом 1с и базой 1c_8_raw.

			В 1с каталоги будут помечены на удаление, а в 1c_8_raw в поле _ПометкаУдаление будет стоять 0.

			Можно посмотреть с помощью следующего запроса:

				SELECT 
					* 
				FROM 
					1C_8_RAW.КаталогиИнтернетМагазина
				WHERE 
					uid = 'сюда подставляем uid каталога на котором валится скрипт, например 61862fdd-f59c-11e1-82bc-002655df3ac1';

		Для решения проблемы нужно обратиться в сектор 1с и попросить полностью перезалить бд 1c_8_raw.

Проблема с выгодными предложениями

	После изменений выгодных предложений они не отображаются на сайтах (korallmicro, snr, istore).

	Причина: потому что падает синхронизация magic с 1с.

	Для решения проблемы:

		узнаем у сообщивших о проблеме, что именно они меняли и где это должно быть на сайтах.

		заходим на боевой magic

			ssh devel@192.168.7.76

			переходим в корень проекта

				cd ~/www/magic

			открываем shell

				bin/manage shell

			запускаем синхронизацию выгодных предложений вручную

				from catalog.tasks import *

				from snr.tasks import *

				sync_offers_korallmicro.delay()

				sync_korallmicro.delay()

				sync_offers_snr.delay()

				sync.delay(site_models='sales_base_models.models', shop_type='snr_new')

		ждем пока закончатся фоновые задачи и обновится кэш

		проверяем, что изменения вступили в силу

Пересекающиеся товары в выгодных предложениях

	Причина: обе акции активны.

	Каждой акции задается время действия.

	Если в акциях есть одинаковые товары и они обе активны, то товары будут пересекаться и это нормально.

	Поэтому первым делом нужно узнать у того, кто написал о проблеме о каких акциях идет речь и проверить в срок действия этих акций.

		заходим в раздел с акциями

			http://magic.km-union.ru/catalog/offers/

		выбираем нужный интернет магазин

		справа в колонке "Типы выгодных предложений" подгрузятся все выгодные предложения этого магазина

		находим и нажимаем на нужное выгодное предложение

		скролим в самый низ и ищём колонку "Выгодные предложения"

		в колонку "Выгодные предложения" должно подгрузиться срок действия выгодного предложения

	Если обе акции активны и вних есть одинаковые товары, то они будут пересекаться. Это нормально поведение.

	Доносим эту мысль человеку, который сообщил об ошибке.

Проблема с количеством товара на сайте

	На 17.08.19 проблемы на этапах:

		1c - вид-подвид

		новинки - не распределяется

			нет Приоритетная группа

			телевизоры и проекторы
			
				232483

			самораживал остатки под новый год

		dp - синки

	По мнению ответсвенных за интернет-магазины на сайтах korallmicro, snr и istore должно быть больше товаров чем есть на данный момент.

	Изначально продукты создаются в 1с.

	Из 1с продукты выгружаются в бд 1c_8_raw.

	Из бд 1c_8_raw продукты выгружаются в бд magic, таблица ones_products.

	Из таблицы ones_products продукты выгружаются в catalog_products, catalog_catalog и создаются связи в catalog_distributions согласно правилам из catalog_rules.

	Из бд magic продукты попадают в бд конкретных сайтов (korallmicro, snr, istore).

	Условия по которым продукт считается пригодным для выгрузки:

		СнятаСПродажи = 0/1

		НеДляПродажи = 0

		НеДляРозницы = 0

		_ПометкаУдаления = 0

		# созданные минимум 12 часов назад
		ДатаСоздания <= date_add(now(),interval -12 hour)

	Из 1с в magic идет выгрузка в таблицы из модуля ones в таске sync_db.

	Затем для каждого магазина запускается таск sync_shop.

	Внутри таска sync_shop сначала идет распределение продуктов в magic по таблицам catalog_products, catalog_catalog и catalog_distributions c помощью метода sync, а затем уже в бд конкретного магазина.

	Korallmicro

		Выгрузка товаров из 1с в 1c_8_raw

			SELECT 
				COUNT(*)
			FROM 
				1C_8_RAW.Номенклатура
			WHERE
				uid IN (
					SELECT 
						Номенклатура
					FROM
						1C_8_RAW.СвязиКаталоговИнтернетМагазина
					WHERE
						КаталогИнтернетМагазина IN (
							SELECT
								uid
							FROM
								1C_8_RAW.КаталогиИнтернетМагазина
							WHERE
								ПланОбмена = (
									SELECT 
										uid
									FROM 
										1C_8_RAW.ПланОбмена
									WHERE
										Наименование = 'Korallmicro'
								)
							AND
								_ПометкаУдаления = 0
						)
				)
			AND
				НеДляПродажи = 0
			AND
				НеДляРозницы = 0
			AND
				_ПометкаУдаления = 0
			AND
				ДатаСоздания <= date_add(now(),interval -12 hour);

			>>> 25101

		Выгрузка товаров из 1c_8_raw в magic

			SELECT
				COUNT(*)
			FROM
				magic.catalog_products as p
			JOIN
				magic.catalog_distributions as d
			ON
				d.product_id = p.code
			JOIN
				magic.catalog_catalog as c
			ON
				c.id = d.catalog_id
			WHERE
				c.type = 'korallmicro';

			>>> 23202

		Те у которых нет связи с каталогом korallmicro

			SELECT 
				COUNT(*)
			FROM 
				1C_8_RAW.Номенклатура
			WHERE
				uid IN (
					SELECT 
						Номенклатура
					FROM
						1C_8_RAW.СвязиКаталоговИнтернетМагазина
					WHERE
						КаталогИнтернетМагазина IN (
							SELECT
								uid
							FROM
								1C_8_RAW.КаталогиИнтернетМагазина
							WHERE
								ПланОбмена = (
									SELECT 
										uid
									FROM 
										1C_8_RAW.ПланОбмена
									WHERE
										Наименование = 'Korallmicro'
								)
							AND
								_ПометкаУдаления = 0
						)
				)
			AND
				НеДляПродажи = 0
			AND
				НеДляРозницы = 0
			AND
				_ПометкаУдаления = 0
			AND
				ДатаСоздания <= date_add(now(),interval -12 hour)
			AND
				Код NOT IN (
					SELECT
						p.code
					FROM
						magic.catalog_products as p
					JOIN
						magic.catalog_distributions as d
					ON
						d.product_id = p.code
					JOIN
						magic.catalog_catalog as c
					ON
						c.id = d.catalog_id
					WHERE
						c.type = 'korallmicro'
				)
			ORDER BY ДатаСоздания DESC

			>>> 1943

		Провереям, что у 1943 продуктов нет связи с каталогом korallmicro, а должна быть

			SELECT 
			    p.code, c.type
			FROM
			    magic.catalog_products AS p
			        JOIN
			    magic.catalog_distributions AS d ON d.product_id = p.code
			        JOIN
			    magic.catalog_catalog AS c ON c.id = d.catalog_id
			WHERE
			    p.code IN (
			        219587,
			        203907
			    );

		Провереям, что у 1943 продуктов есть связи с каталогом korallmicro в 1с_8_raw

			SELECT
				count(*)
				product.Код,
				category_product.КаталогИнтернетМагазина
			FROM
			    1C_8_RAW.Номенклатура AS product
			        JOIN
			    1C_8_RAW.СвязиКаталоговИнтернетМагазина AS category_product ON category_product.Номенклатура = product.uid
					JOIN
				1C_8_RAW.КаталогиИнтернетМагазина AS category ON category.uid = category_product.КаталогИнтернетМагазина
			WHERE
				category.ПланОбмена = (
					SELECT
						plan.uid
					FROM
						1C_8_RAW.ПланОбмена AS plan
					WHERE
						plan.Наименование = 'korallmicro'
				)
				AND
					product.Код IN (
						213787, 
						206999,
					);

		Термины

			номенклатура == продукт

			каталог == категория

			связь продукта с категорией == СвязиКаталоговИнтернетМагазина == catalog_distributions

		Смотрим продукт 1с - magic

			SELECT 
			    *
			FROM
			    1C_8_RAW.Номенклатура
			WHERE
				Код = 184512;

			------

			SELECT 
			    *
			FROM
			    magic.catalog_products
			WHERE
			    code = 213787;

		Смотрим связь продукта с категорией 1с - magic

			SELECT 
			    *
			FROM
			    1C_8_RAW.СвязиКаталоговИнтернетМагазина
			WHERE
				Номенклатура = '33ebd596-a479-11e9-80e1-6805ca44419c';

			------

			SELECT 
			    *
			FROM
			    magic.catalog_distributions
			WHERE
			    product_id = 213787;

		Смотрим категории 1с - magic

			SELECT 
			    КаталогиИнтернетМагазина.uid,
			    КаталогиИнтернетМагазина.Наименование,
			    ПланОбмена.Наименование
			FROM
			    1C_8_RAW.КаталогиИнтернетМагазина
			        JOIN
			    1C_8_RAW.ПланОбмена ON КаталогиИнтернетМагазина.ПланОбмена = ПланОбмена.uid
			WHERE
			    КаталогиИнтернетМагазина.uid IN (
					'61863006-f59c-11e1-82bc-002655df3ac1',
			        '801059df-1fbd-11e9-80d9-6805ca44419c',
			        'bd15d28a-2714-11e5-80d9-001b21d8d330',
			        'd155349c-fd61-11e5-93f9-001b21d8d330'
				);

			-------

			SELECT
				full_name,
				type
			FROM
				magic.catalog_catalog
			WHERE
				id IN (318290);

		Смотрим наличие карточки товара в magic и стоит ли date_formed_description

			SELECT 
			    *
			FROM
			    magic.cards_productcard
			WHERE
				code = 213787;

		Смотрим есть ли слепок карточки товара

			SELECT 
			    *
			FROM
			    magic.cards_productcarddescription
			WHERE
				card_id = 60627;

		Смотрим остатки 1с - dp

			SELECT 
			    *
			FROM
			    1C_8_RAW.Остатки
			WHERE
			    Номенклатура = '0978b6c9-cbb4-11e8-80d7-6805ca44419c';

			------

			SELECT 
				* 
			FROM 
				public.remains 
			WHERE 
				pid=197416;

			------

			from sales_base_models.models import * 

			Remains.objects.filter(sid=Site.objects.get(subdomain='www').pk, pid=184512)

		Смотрим наличие цены 1с - dp

			SELECT 
			    *
			FROM
			    1C_8_RAW.Цены
			WHERE
			    Номенклатура = '21609ef0-3b93-11e7-80c7-6805ca44419c';

			------

			SELECT 
				*  
			FROM 
				public.prices 
			WHERE 
				pid=197416;

			------

			from sales_base_models.models import * 

			Prices.objects.filter(sid=Site.objects.get(subdomain='www').pk, pid=184512)

		Смотрим наличие продукта в базе магазина

			SELECT 
				* 
			FROM 
				public.products 
			WHERE 
				id=197416;

		Вид-тип-бренд и каталог

			Нет нужной связи в catalog_distributions и она не может сформироваться, потому что product_uuids = get_product_uuids_for_sale, не берет нужный продукт из-за отсутсвия нужной связи вид-типа-бренда и каталога

				SELECT 
				    *
				FROM
				    magic.catalog_rules;

			Где взять vtb_id

				SELECT 
				    vtb_id
				FROM
				    magic.ones_products
				WHERE
					code = 225550;

			Цепочка

				184512, 228869, 197416

					Номенклатура

						Нет пометок

						SELECT 
						    *
						FROM
						    1C_8_RAW.Номенклатура
						WHERE
							Код = 197416;

					Распределение каталогов сайтов

						"Иерархия объектов обмена"

						Не указал папку

						Не указал правильный вид-подвид

						Вид-подвид не соответсвовал группе

						Папка и бери из неё все

					Мэджик каталоги

						Если видит, то супер

					Мэджик карточка

						Фото, валидация

					В dp "цены и остатки"

						korallmicro

						поиск по всем каталогам

						смотрю папку в иерархии dp

						есть тип цены, но он не влияет на выгрузку

							инэт магаз

							по акции

							ррц рекомендуемая розничная цена производителя

					Закупка кладет товар в папку

						"Если решили переложить в другую папку, то он просто пропадает"

