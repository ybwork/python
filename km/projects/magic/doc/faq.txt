Оглавление

	Галочка "Не для интернет магазина"

	Кол-во распределенного товара вне диапозона

	Бесконечный цикл при создании каталогов

	Проблема с выгодными предложениями

	Проблема с количеством товара на сайте

Галочка "Не для интернет магазина"

	В 1с товару поставили галочку "Не для интернет магазина", но он всеравно отображается на сайте

		Причина: потому что товар отвязан от категории в 1c. Смотреть в разделе "Иерархия групп объектов обмена".

		На 4.09.19 если в 1с стоит галочка "Не для интернет магазина", то это значит, что продукт не должен быть на сайтах korallmicro и istore.

		Если говорить в терминах 1с, то номеклатура не имеет связи с каталогом.

		Для того, чтобы исправить ситуацию нужно:

			привязать номенклатуру к каталогу в 1с

			найти в бд magic лишние связи товара с категорией для сайтов korallmicro и istore:

				SELECT
				    c_c.id,
				    c_c.type
				FROM
				    magic.catalog_distributions c_d
				        LEFT JOIN
				    magic.catalog_catalog c_c ON c_d.catalog_id = c_c.id
				WHERE
				    product_id = 1987
				        AND c_c.type IN ('korallmicro' , 'istore');

			удаляем из бд magic лишние связи товара с категорией для сайтов korallmicro и istore:

				DELETE FROM
				    magic.catalog_distributions
				WHERE
				    product_id = 1987
				        AND catalog_id IN (281904, 319023)

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

		Если не помогло, то:

			просим ответственного за проект убрать у продукта в 1с галочку "Не для интернет магазина"

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

			просим ответственного за проект вернуть продукту в 1с галочку "Не для интернет магазина"

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

Кол-во распределенного товара вне диапозона

	Ошибка при синхронизации с 1с "Кол-во распределенного товара вне диапозона".

		Причина: потому что кол-во продуктов в 1с сильно отличается от кол-ва продуктов в magic.

		Если ответственный за проект много работал в 1с с продуктами, то это нормальная ситуация.

		Для решения проблемы нужно связаться с ответственным за проект и узнать работал ли он с продуктами и каталогами в 1с. 

			Если работал, то просим у ответсвенного за проект разрешения на "синхронизацию без доверительного интервала".

			Если разрешает, то:

				находим на рабочей почте письмо об ошибке и смотрим для какого магазина она произошла (snr, korallmicro, istore)

					Task was called with args: [] kwargs: {u'shop_type': u'korallmicro'}

					Это говорит, что ошибка произошла при синхронизации для korallmicro

				в 1-ой консоле заходим на боевой magic

					ssh devel@192.168.7.76

					открываем файл с логами, выполняющихся фоновых задач

						tail -f ~/log/magic-celery-system.txt

				во 2-ой консоле заходим на боевой magic

					ssh devel@192.168.7.76

					переходим в корень проекта

						cd ~/www/magic

					смотрим в открытый файл с логами выполняющихся фоновых задач и убеждаемся, что нет запущенных sync_shop

					выполняем синхронизацию для нужного магазина вручную и без сравнения кол-ва товаров

						bin/celery call -A app_celery sync_shop --queue=system --args='["название нужного магазина, например istore", false]'

		Если ответсвенного за проект не разрешает выполнить "синхронизацию без доверительного интервала", то исследуем код и ищем проблему.

			открываем /magic/modules/catalog/tasks.py

			ищем там if use_confidence_interval

			разбираемся

Бесконечный цикл при создании каталогов

	Ошибка при синхронизации с 1с "Бесконечный цикл при создании каталогов".

		Причина: потому что в 1с помеченный "на удаление" каталог, не удаляется из базы 1c_8_raw.

		Смотреть разницу между интерфейсом 1с и базой 1c_8_raw.

			В 1с каталоги будут помечены на удаление, а в 1c_8_raw в поле _ПометкаУдаление будет стоять 0.

			Можно посмотреть с помощью следующего запроса:

				SELECT 
					* 
				FROM 
					1C_8_RAW.КаталогиИнтернетМагазина
				WHERE 
					uid = 'сюда подставляем uid каталога на котором валится скрипт, например 61862fdd-f59c-11e1-82bc-002655df3ac1';

		Для решения проблемы нужно обратиться в сектор 1с и попросить полностью перезалить бд 1c_8_raw.

Проблема с выгодными предложениями

	После изменений выгодных предложений они не отображаются на сайтах (korallmicro, snr, istore).

	Причина: потому что падает синхронизация magic с 1с.

	Для решения проблемы:

		узнаем у сообщивших о проблеме, что именно они меняли и где это должно быть на сайтах.

		заходим на боевой magic

			ssh devel@192.168.7.76

			переходим в корень проекта

				cd ~/www/magic

			открываем shell

				bin/manage shell

			запускаем синхронизацию выгодных предложений вручную

				from catalog.tasks import *

				from snr.tasks import *

				sync_offers_korallmicro.delay()

				sync_korallmicro.delay()

				sync_offers_snr.delay()

				sync.delay(site_models='sales_base_models.models', shop_type='snr_new')

		ждем пока закончатся фоновые задачи и обновится кэш

		проверяем, что изменения вступили в силу

Пересекающиеся товары в выгодных предложениях

	Причина: обе акции активны.

	Каждой акции задается время действия.

	Если в акциях есть одинаковые товары и они обе активны, то товары будут пересекаться и это нормально.

	Поэтому первым делом нужно узнать у того, кто написал о проблеме о каких акциях идет речь и проверить в срок действия этих акций.

		заходим в раздел с акциями

			http://magic.km-union.ru/catalog/offers/

		выбираем нужный интернет магазин

		справа в колонке "Типы выгодных предложений" подгрузятся все выгодные предложения этого магазина

		находим и нажимаем на нужное выгодное предложение

		скролим в самый низ и ищём колонку "Выгодные предложения"

		в колонку "Выгодные предложения" должно подгрузиться срок действия выгодного предложения

	Если обе акции активны и вних есть одинаковые товары, то они будут пересекаться. Это нормально поведение.

	Доносим эту мысль человеку, который сообщил об ошибке.

Проблема с количеством товара на сайте

	По мнению ответсвенных за интернет-магазины на сайтах korallmicro, snr и istore должно быть больше товаров чем есть на данный момент.

	Изначально продукты создаются в 1с.

	Из 1с продукты выгружаются в бд 1c_8_raw.

	Из бд 1c_8_raw продукты выгружаются в бд magic, таблица ones_products.

	Из таблицы ones_products продукты выгружаются в catalog_products, catalog_catalog и создаются связи в catalog_distributions согласно правилам из catalog_rules.

	Из бд magic продукты попадают в бд конкретных сайтов (korallmicro, snr, istore).

	Условия по которым продукт считается пригодным для выгрузки:

		НеДляПродажи = 0

		НеДляРозницы = 0

		_ПометкаУдаления = 0

		# созданные минимум 12 часов назад
		ДатаСоздания <= date_add(now(),interval -12 hour)

	Korallmicro

		Выгрузка товаров из 1с в 1c_8_raw

			SELECT 
				COUNT(*)
			FROM 
				1C_8_RAW.Номенклатура
			WHERE
				uid IN (
					SELECT 
						Номенклатура
					FROM
						1C_8_RAW.СвязиКаталоговИнтернетМагазина
					WHERE
						КаталогИнтернетМагазина IN (
							SELECT
								uid
							FROM
								1C_8_RAW.КаталогиИнтернетМагазина
							WHERE
								ПланОбмена = (
									SELECT 
										uid
									FROM 
										1C_8_RAW.ПланОбмена
									WHERE
										Наименование = 'Korallmicro'
								)
							AND
								_ПометкаУдаления = 0
						)
				)
			AND
				НеДляПродажи = 0
			AND
				НеДляРозницы = 0
			AND
				_ПометкаУдаления = 0
			AND
				ДатаСоздания <= date_add(now(),interval -12 hour);

			>>> 25065

		Выгрузка товаров из 1c_8_raw в magic

			SELECT
				COUNT(*)
			FROM
				magic.catalog_products as p
			JOIN
				magic.catalog_distributions as d
			ON
				d.product_id = p.code
			JOIN
				magic.catalog_catalog as c
			ON
				c.id = d.catalog_id
			WHERE
				c.type = 'korallmicro';

			>>> 23152

		Находим разницу не выгруженныйх товаров из 1с в magic

			SELECT 
				COUNT(*)
			FROM 
				1C_8_RAW.Номенклатура
			WHERE
				uid IN (
					SELECT 
						Номенклатура
					FROM
						1C_8_RAW.СвязиКаталоговИнтернетМагазина
					WHERE
						КаталогИнтернетМагазина IN (
							SELECT
								uid
							FROM
								1C_8_RAW.КаталогиИнтернетМагазина
							WHERE
								ПланОбмена = (
									SELECT 
										uid
									FROM 
										1C_8_RAW.ПланОбмена
									WHERE
										Наименование = 'Korallmicro'
								)
							AND
								_ПометкаУдаления = 0
						)
				)
			AND
				НеДляПродажи = 0
			AND
				НеДляРозницы = 0
			AND
				_ПометкаУдаления = 0
			AND
				ДатаСоздания <= date_add(now(),interval -12 hour)
			AND
				Код NOT IN (
					SELECT
						p.code
					FROM
						magic.catalog_products as p
					JOIN
						magic.catalog_distributions as d
					ON
						d.product_id = p.code
					JOIN
						magic.catalog_catalog as c
					ON
						c.id = d.catalog_id
					WHERE
						c.type = 'korallmicro';
				)

			>>> 1958

		Смотрим конкретную карточку товара в каталогах, продуктах и связях magic

			SELECT 
			    *
			FROM
			    magic.catalog_products
			WHERE
			    code = 213787;

			>>> Есть

			------

			SELECT 
			    *
			FROM
			    magic.catalog_distributions
			WHERE
			    product_id = 213787;

			>>> Есть

			------

			SELECT 
			    *
			FROM
			    magic.catalog_catalog
			WHERE
			    id = 318290;

			>>> Привязан только к каталогу типа snr_new и это косяк, а в 1c_8_raw все четко

		Смотрим остатки

			SELECT 
			    *
			FROM
			    1C_8_RAW.Остатки
			WHERE
			    Номенклатура = '0978b6c9-cbb4-11e8-80d7-6805ca44419c';

		Смотрим наличие карточки товара в magic и стоит ли date_formed_description

			SELECT 
			    *
			FROM
			    magic.cards_productcard
			WHERE
				code = 213787;

		Смотрим есть ли слепок карточки товара

			SELECT 
			    *
			FROM
			    magic.cards_productcarddescription
			WHERE
				card_id = 60627;
