Оглавление

	Галочка "Не для интернет магазина"

	Кол-во распределенного товара вне диапозона

	Бесконечный цикл при создании каталогов

	Проблема с выгодными предложениями

	Проблема с количеством товара на сайте

Галочка "Не для интернет магазина"

	В 1с товару поставили галочку "Не для интернет магазина", но он всеравно отображается на сайте

		Причина: потому что товар отвязан от категории в 1c. Смотреть в разделе "Иерархия групп объектов обмена".

		На 4.09.19 если в 1с стоит галочка "Не для интернет магазина", то это значит, что продукт не должен быть на сайтах korallmicro и istore.

		Если говорить в терминах 1с, то номеклатура не имеет связи с каталогом.

		Для того, чтобы исправить ситуацию нужно:

			привязать номенклатуру к каталогу в 1с

			найти в бд magic лишние связи товара с категорией для сайтов korallmicro и istore:

				SELECT
				    c_c.id,
				    c_c.type
				FROM
				    magic.catalog_distributions c_d
				        LEFT JOIN
				    magic.catalog_catalog c_c ON c_d.catalog_id = c_c.id
				WHERE
				    product_id = 1987
				        AND c_c.type IN ('korallmicro' , 'istore');

			удаляем из бд magic лишние связи товара с категорией для сайтов korallmicro и istore:

				DELETE FROM
				    magic.catalog_distributions
				WHERE
				    product_id = 1987
				        AND catalog_id IN (281904, 319023)

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

		Если не помогло, то:

			просим ответственного за проект убрать у продукта в 1с галочку "Не для интернет магазина"

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

			просим ответственного за проект вернуть продукту в 1с галочку "Не для интернет магазина"

			ждем пока пройдет полная синхронизаци magic с 1с и сбросится кэш

Кол-во распределенного товара вне диапозона

	Ошибка при синхронизации с 1с "Кол-во распределенного товара вне диапозона".

		Причина: потому что кол-во продуктов в 1с сильно отличается от кол-ва продуктов в magic.

		Если ответственный за проект много работал в 1с с продуктами, то это нормальная ситуация.

		Для решения проблемы нужно связаться с ответственным за проект и узнать работал ли он с продуктами и каталогами в 1с. 

			Если работал, то просим у ответсвенного за проект разрешения на "синхронизацию без доверительного интервала".

			Если разрешает, то:

				находим на рабочей почте письмо об ошибке и смотрим для какого магазина она произошла (snr, korallmicro, istore)

					Task was called with args: [] kwargs: {u'shop_type': u'korallmicro'}

					Это говорит, что ошибка произошла при синхронизации для korallmicro

				в 1-ой консоле заходим на боевой magic

					ssh devel@192.168.7.76

					открываем файл с логами, выполняющихся фоновых задач

						tail -f ~/log/magic-celery-system.txt

				во 2-ой консоле заходим на боевой magic

					ssh devel@192.168.7.76

					переходим в корень проекта

						cd ~/www/magic

					смотрим в открытый файл с логами выполняющихся фоновых задач и убеждаемся, что нет запущенных sync_shop

					выполняем синхронизацию для нужного магазина вручную и без сравнения кол-ва товаров

						bin/celery call -A app_celery sync_shop --queue=system --args='["название нужного магазина, например istore", false]'

		Если ответсвенного за проект не разрешает выполнить "синхронизацию без доверительного интервала", то исследуем код и ищем проблему.

			открываем /magic/modules/catalog/tasks.py

			ищем там if use_confidence_interval

			разбираемся

Бесконечный цикл при создании каталогов

	Ошибка при синхронизации с 1с "Бесконечный цикл при создании каталогов".

		Причина: потому что в 1с помеченный "на удаление" каталог, не удаляется из базы 1c_8_raw.

		Смотреть разницу между интерфейсом 1с и базой 1c_8_raw.

			В 1с каталоги будут помечены на удаление, а в 1c_8_raw в поле _ПометкаУдаление будет стоять 0.

			Можно посмотреть с помощью следующего запроса:

				SELECT 
					* 
				FROM 
					1C_8_RAW.КаталогиИнтернетМагазина
				WHERE 
					uid = 'сюда подставляем uid каталога на котором валится скрипт, например 61862fdd-f59c-11e1-82bc-002655df3ac1';

		Для решения проблемы нужно обратиться в сектор 1с и попросить полностью перезалить бд 1c_8_raw.

Проблема с выгодными предложениями

	После изменений выгодных предложений они не отображаются на сайтах (korallmicro, snr, istore).

	Причина: потому что падает синхронизация magic с 1с.

	Для решения проблемы:

		узнаем у сообщивших о проблеме, что именно они меняли и где это должно быть на сайтах.

		заходим на боевой magic

			ssh devel@192.168.7.76

			переходим в корень проекта

				cd ~/www/magic

			открываем shell

				bin/manage shell

			запускаем синхронизацию выгодных предложений вручную

				from catalog.tasks import *

				from snr.tasks import *

				sync_offers_korallmicro.delay()

				sync_korallmicro.delay()

				sync_offers_snr.delay()

				sync.delay(site_models='sales_base_models.models', shop_type='snr_new')

		ждем пока закончатся фоновые задачи и обновится кэш

		проверяем, что изменения вступили в силу

Пересекающиеся товары в выгодных предложениях

	Причина: обе акции активны.

	Каждой акции задается время действия.

	Если в акциях есть одинаковые товары и они обе активны, то товары будут пересекаться и это нормально.

	Поэтому первым делом нужно узнать у того, кто написал о проблеме о каких акциях идет речь и проверить в срок действия этих акций.

		заходим в раздел с акциями

			http://magic.km-union.ru/catalog/offers/

		выбираем нужный интернет магазин

		справа в колонке "Типы выгодных предложений" подгрузятся все выгодные предложения этого магазина

		находим и нажимаем на нужное выгодное предложение

		скролим в самый низ и ищём колонку "Выгодные предложения"

		в колонку "Выгодные предложения" должно подгрузиться срок действия выгодного предложения

	Если обе акции активны и вних есть одинаковые товары, то они будут пересекаться. Это нормально поведение.

	Доносим эту мысль человеку, который сообщил об ошибке.

Проблема с количеством товара на сайте

	Описание проблемы

		На сайтах korallmicro, snr и istore должно быть больше товаров чем есть на данный момент.

		Особые проблемы наблюдаются в разделе новинки.

		Также ежедневно общее кол-во товаров на сайтах уменьшается.

	Термины

		номенклатура == продукт

		каталог == категория

		СвязиКаталоговИнтернетМагазина == связь продукта с категорией  == catalog_distributions (magic)

	Синхронизация

		В процессе от создания до появления продукта на сайте участвуют системы 1с, magic, dp, sdp.

		Процесс выгрузки данных из одной системы в другую называется синхронизация.

		В целом синхронизация работает так:

			Данные появляются в 1с.

			Из 1с данные выгружаются в бд 1c_8_raw.

			Из 1c_8_raw данные выгружаются в magic.

			Из magic данные попадают на сайты.

			Dp проставляет цены и остатки продуктам, которые попали на сайты.

	Условия 1с при которых номенклатура должна попасть на сайт

		Не стоят галочки "НеДляПродажи", "НеДляРозницы", "_ПометкаУдаления".

		Создан минимум 12 часов назад.

		Привязан к каталогу.

		Правильно заданы вид-подвид (в названии регистр имеет значение).

		(?) Правильно заданы правила распределения.

	Условия magic при которых продукт должен попасть на сайт

		После синхронизации с 1с продукт появился в magic и он привязан к каталогу нужного сайта.

		У каталога к которому привязан продукт стоит галочка "Приоритетная группа". 

		Созданна карточка товара с таким же кодом, как и продукта.

		Карточка товара имеет код, бренд, вид-тип, валидные картинки, заполненное поле "date_formed_description", статус "актуальна", слепок, готова к проверке, проверена.

	(?) Условия dp при которых продукту должны проставиться цены и остатки

		...

	Условия сайта при которых продукт должен отображаться

		Продукт попал в базу сайта.

		Продукт связан с каталогом.

		У каталога к которому привязан продукт стоит галочка "Приоритетная группа".

		У продукта есть остатки и цены.

	Узкие места из-за которых могут быть проблемы:

		1с

			Номенклатура не привязана к каталогу.

			Не правильно заданы правила распределения.

			У номенклатуры неправильно задан вид-подвид. В названии обратить внимание на ригистр и id-ки.

		Magic

			Нет карточки товара для продукта.

			Карточка товара не валидна.

			Нет слепка карточки товара.

			Каталог в котором находится продукт не имеет галочки "Приоритетная группа"

		(?) Dp

			...

		Сайт

			Продукт не попал в базу.

			Продукт не опубликован.

			Группа в которую распределен продукт не приоритетная.

			У продукта нет цен и остатков.

	Как в 1с проверить номенклатуру

		SELECT 
			*
		FROM 
			1C_8_RAW.Номенклатура
		WHERE
			-- подставляем свой код
			Код = 212149
				AND
			-- созданные минимум 12 часов назад
			ДатаСоздания <= date_add(now(),interval -12 hour)

		В этих полях должны быть следующие занчения:

			СнятаСПродажи = 0/1 (никакой роли не играет, но вводит в заблуждение, поэтому написал о нем)

			НеДляПродажи = 0

			НеДляРозницы = 0/1 (если 1, то не должен отображаться на korallmicro)

			НеДляСНР = 0/1 (если 1, то не должен отображаться на snr)

			_ПометкаУдаления = 0

	Как в 1с проверить, что номенклатура привязана к каталогу нужного сайта

		У каждого каталога есть план обмена.

		Для каждого магазина есть план обмена с таким же именем.

		Если нам нужно проверить, что номенклатура привязана к каталогу магазина korallmicro, то у каталога должен быть план обмена с именем korallmicro.

		Одна и таже номенклатура может быть привязана к каталогам разных магазинов.

			SELECT
			    КаталогиИнтернетМагазина.Наименование AS catalog,
			    ПланОбмена.Наименование AS shop
			FROM
			    1C_8_RAW.КаталогиИнтернетМагазина
			        JOIN
			    1C_8_RAW.ПланОбмена ON КаталогиИнтернетМагазина.ПланОбмена = ПланОбмена.uid
			WHERE
			    КаталогиИнтернетМагазина.uid IN (
					SELECT 
					    КаталогИнтернетМагазина
					FROM
					    1C_8_RAW.СвязиКаталоговИнтернетМагазина
					WHERE
						-- подставляем свой uid номенклатуры
						Номенклатура = '00028cb9-b1fd-11e2-93f1-002655df3ac1'
				);

		Обращаем внимание на значение в поле "shop" и если находим нужный, то значит номенклатура привязана к каталогу.

	Как в 1с посмотреть кол-во номенклатуры, которая связана с каталогами нужного магазина

		Для смены магазина подставляем нужное значение на место 'Korallmicro' в запросе.

		Возможные варианты смотреть в таблице ПланыОбмена базы 1C_8_RAW:

			SELECT 
				*
			FROM 
				1C_8_RAW.ПланОбмена;

		SELECT 
		    COUNT(*)
		FROM
		    1C_8_RAW.Номенклатура
		WHERE
		    uid IN (
		    	SELECT 
		            Номенклатура
		        FROM
		            1C_8_RAW.СвязиКаталоговИнтернетМагазина
		        WHERE
		            КаталогИнтернетМагазина IN (
		            	SELECT 
		                    uid
		                FROM
		                    1C_8_RAW.КаталогиИнтернетМагазина
		                WHERE
		                    ПланОбмена = (
								SELECT 
								    uid
								FROM
								    1C_8_RAW.ПланОбмена
								WHERE
								    Наименование = 'Korallmicro'
								        AND _ПометкаУдаления = 0
		                    )
		            )
		    )
	        AND НеДляПродажи = 0
	        AND НеДляРозницы = 0
	        AND _ПометкаУдаления = 0
	        AND ДатаСоздания <= DATE_ADD(NOW(), INTERVAL - 12 HOUR);

	(?) Как посмотреть в 1с вид-подвид номенклатуры

		SELECT 
		    Номенклатура.Код AS код,
		    Номенклатура.Наименование AS название,
		    КаталогиИнтернетМагазина.Наименование AS каталог,
		    ВидыТипыБренды.Наименование AS вид
		FROM
		    1C_8_RAW.Номенклатура
		        JOIN
		    1C_8_RAW.ВидыПодвидыКаталогов ON ВидыПодвидыКаталогов.ВидНоменклатуры = Номенклатура.Вид
		        AND ВидыПодвидыКаталогов.ПодвидНоменклатуры = Номенклатура.Тип
		        JOIN
		    1C_8_RAW.КаталогиИнтернетМагазина ON КаталогиИнтернетМагазина.uid = ВидыПодвидыКаталогов.Идентификатор
				JOIN
			1C_8_RAW.ВидыТипыБренды ON ВидыТипыБренды.uid IN (Номенклатура.Вид, Номенклатура.Тип)
		WHERE
		    Номенклатура.Код = 192825;

	Как проверить, что после синхронизации продукт попал в magic

		SELECT
			product.code,
			product.name,
			catalog.name AS catalog,
			catalog.type AS shop
		FROM
			magic.catalog_products AS product
				JOIN
			magic.catalog_distributions AS catalog_product ON catalog_product.product_id = product.code
				JOIN
			magic.catalog_catalog AS catalog ON catalog.id = catalog_product.catalog_id
		WHERE
			-- подставить нужный код
			product.code = 47633;

		Обращаем внимание на каталог в который он попал и к какому магазину этот каталог относится.

		Сравниваем данные с данными из 1C_8_RAW.

	Как проверить, что в magic для продукта есть полностью валидная карточка товара

		SELECT
			cards_productcard.code 
		FROM
			magic.cards_productcard
				LEFT OUTER JOIN
			magic.cards_productcardimage ON cards_productcard.id = cards_productcardimage.card_id
				INNER JOIN
			magic.cards_kind ON cards_productcard.kind_id = cards_kind.id
				INNER JOIN
			magic.cards_property ON cards_kind.id = cards_property.kind_id
		WHERE
			cards_productcard.code = 89
			AND cards_productcard.is_checked = TRUE
			AND cards_productcard.is_actual = TRUE
			AND cards_productcard.brand_id IS NOT NULL
			AND cards_productcard.code IS NOT NULL
			AND cards_productcard.has_invalid_images = FALSE
			AND cards_productcard.is_ready = TRUE
			AND cards_productcard.is_checked = TRUE
			AND cards_property.id IS NOT NULL
			AND cards_productcard.date_formed_description IS NOT NULL
		GROUP BY cards_productcard.id
		HAVING COUNT(cards_productcardimage.id) > 0
		ORDER BY cards_productcard.code ASC

		Если запрос вернул код продукта занчит с картокой продукта все в порядке.

		------

		ProductCard.objects.filter(
			date_formed_description__isnull=False
		).get_checked().get_actual().get_verified()

	Как посмотреть в magic карточки товара помеченные, как "проверена" за определенный срок

		bin/manage shell

		from cards.models import *

		list(
			ProductCard.objects.filter(
				date_checked__gte=datetime(2019, 9, 18), date_formed_description__isnull=False
			).values_list(
				'code', 
				flat=True
			)
		)

	Как проверить, что после синхронизации с magic продукт попал в бд магазина

		SELECT 
		    product.id AS code,
			product.uuid AS uid,
			product.published,
			product.new,
			category.name AS category,
			category.is_priority_group
		FROM
		    public.products AS product
		 		JOIN
		 	public.distributions AS category_product ON category_product.pid = product.id
		  		JOIN
		 	public.catalogs AS category ON category.gid = category_product.gid
		WHERE
		    product.id = 231367;

		Обратить внимание на поля и значения:

			published - true

			is_priority_group - true

	Как в 1с проверить, что у номенклатуры есть остатки

		Нюансы:

			если остатков нет, то нет и записи

		SELECT 
			*
		FROM
			1C_8_RAW.Остатки
		WHERE
			-- подставляем свой uid номенклатуры
			Номенклатура = '0978b6c9-cbb4-11e8-80d7-6805ca44419c';

	Как проверить в бд магазина, что у продукта есть остатки

		Нюансы:

			pid == коду продукта

			если остатков нет, то нет и записи

			если в полях нулевые значения, то товар должен отображаться на сайте с пометкой "под заказ"

		SELECT 
		    *
		FROM
		    public.remains
		WHERE
			-- подставляем свой pid
		    pid = 281727;

	Как в 1с проверить, что у номенклатуры есть цены

		SELECT 
		    *
		FROM
		    1C_8_RAW.Цены
		WHERE
		    Номенклатура = '21609ef0-3b93-11e7-80c7-6805ca44419c';

	Как проверить в бд магазина, что у продукта есть цены

		SELECT 
			*  
		FROM 
			public.prices 
		WHERE
			-- подставляем свой pid
			pid=197416;

	Куда смотреть в magic

		Выгрузка из 1с в magic

			Из бд 1C_8_RAW продукты выгружаются в бд magic, таблица ones_products.

				Смотреть в /modules/ones/tasks/__init__.py

				Задача sync_db.

			Из таблицы ones_products продукты выгружаются в catalog_products, catalog_catalog и создаются связи в catalog_distributions согласно правилам из catalog_rules.

				Смотреть в /modules/catalog/tasks.py

				Задача sync_shop

		Выгрузка из magic на сайты

			Из бд magic продукты попадают в бд конкретных сайтов (korallmicro, snr, istore).

			Из 1с в magic идет выгрузка в таблицы из модуля ones в таске sync_db.

			Затем для каждого магазина запускается таск sync_shop.

			Внутри таска sync_shop сначала идет распределение продуктов в magic по таблицам catalog_products, catalog_catalog и catalog_distributions c помощью метода sync, а затем уже в бд конкретного магазина.

		Галочка "приоритетна группа"

			Ставится только в magic в разделе "Каталоги" и в фоновой задаче.

			Если у родительского каталога убрать или добавить галочку "приоритетная группа", то и в дочерних каталогах она изменится.

				Смотреть в /modules/catalog/models.py

				Метод set_priority_group

			Если у каталога в 1с родитель = '00000000-0000-0000-0000-000000000000', то в фоновой задаче галочка сбросится. 

				Если у каталога в 1с родитель = '00000000-0000-0000-0000-000000000000', то это значит что этот каталог верхнего уровня.

				Смотреть в /modules/catalog/tasks.py

				Метод sync, который вызывается в задаче sync_shop

			Если у каталога в 1с есть родитель, то значение галочки будет браться из magic.

			Заходим в раздел каталоги.

			Нажимаем на любой каталог 2 раза.

			Оказываемся на странице редактирования каталога

				/catalog/catalog/281727/change/

			Находим галочку "приоритетна группа".

			Также галочка "приоритетная группа" устанавливается при выполнения фоновой задачи

				Смотреть в /modules/catalog/tasks.py

				Метод sync, который вызывается в задаче sync_shop

	Как построить отчет для заказчика

		кол-во товаров в 1c_8_raw по конкретному сайту

			SELECT 
			    COUNT(*)
			FROM
			    1C_8_RAW.Номенклатура
			WHERE
			    uid IN (
			    	SELECT 
			            Номенклатура
			        FROM
			            1C_8_RAW.СвязиКаталоговИнтернетМагазина
			        WHERE
			            КаталогИнтернетМагазина IN (
			            	SELECT 
			                    uid
			                FROM
			                    1C_8_RAW.КаталогиИнтернетМагазина
			                WHERE
			                    ПланОбмена = (
									SELECT 
									    uid
									FROM
									    1C_8_RAW.ПланОбмена
									WHERE
									    Наименование = 'Korallmicro'
									        AND _ПометкаУдаления = 0
			                    )
			            )
			    )
		        AND НеДляПродажи = 0
		        AND НеДляРозницы = 0
		        AND _ПометкаУдаления = 0;

		кол-во карточек товара в magic

			SELECT
				count(*)
			FROM
				magic.cards_productcard

		кол-во актуальных (в продаже), готовых к проверке и проверенных карточек товара в magic

			SELECT
				count(*)
			FROM
				magic.cards_productcard
			WHERE
				cards_productcard.is_actual = TRUE
	 			AND cards_productcard.is_ready = TRUE
	 			AND cards_productcard.is_checked = TRUE;

		кол-во карточек товара с брендом в magic

			SELECT
				count(*)
			FROM
				magic.cards_productcard
			WHERE
				cards_productcard.is_actual = TRUE
				AND cards_productcard.is_ready = TRUE
				AND cards_productcard.is_checked = TRUE
				AND cards_productcard.brand_id IS NOT NULL;

		кол-во карточек товара без галочки невалидные изображения в magic

			SELECT
				count(*)
			FROM
				magic.cards_productcard
			WHERE
				cards_productcard.is_actual = TRUE
				AND cards_productcard.is_ready = TRUE
				AND cards_productcard.is_checked = TRUE
				AND cards_productcard.brand_id IS NOT NULL
			    AND cards_productcard.has_invalid_images = FALSE;

		кол-во которые прошли системную проверку

			SELECT
				count(*)
			FROM
				magic.cards_productcard
					INNER JOIN
				magic.cards_kind ON cards_productcard.kind_id = cards_kind.id
					INNER JOIN
				magic.cards_property ON cards_kind.id = cards_property.kind_id
			WHERE
				cards_productcard.is_actual = TRUE
				AND cards_productcard.is_ready = TRUE
				AND cards_productcard.is_checked = TRUE
				AND cards_productcard.brand_id IS NOT NULL
			    AND cards_productcard.has_invalid_images = FALSE
			    AND cards_productcard.code IS NOT NULL
				AND cards_property.id IS NOT NULL
				AND cards_productcard.date_formed_description IS NOT NULL;

		кол-во товаров на конкретном

			SELECT
				count(*)
			FROM
				public.products AS product
					JOIN
				public.distributions AS category_product ON category_product.pid = product.id
					JOIN
				public.catalogs AS category ON category.gid = category_product.gid
			WHERE
				product.published = True;

		кол-во распределенных товаров в magic для конкретного сайта

			SELECT
				count(*)
			FROM
				magic.catalog_products AS product
					JOIN
				magic.catalog_distributions AS catalog_product ON catalog_product.product_id = product.code
					JOIN
				magic.catalog_catalog AS catalog ON catalog.id = catalog_product.catalog_id
			WHERE
				catalog.type = 'korallmicro';

		коды продуктов, которые выгрузились из 1с в magic, но у них нет карточки товара в magic

			bin/manage shell

			from cards.models import *

			from catalog.models import *

			product_card = ProductCard.objects.filter(
			    date_formed_description__isnull=False
			).get_checked().get_actual().get_verified().values_list('code', flat=True)

			len(product_card)

			products = Products.objects.filter(distributions__catalog__type='korallmicro').values_list('code', flat=True)

			len(products)

			res = set(products) - set(product_card)

			len(res)

			print(res)
